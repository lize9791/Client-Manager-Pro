{"version":3,"mappings":"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","names":["supabaseUrl","supabaseAnonKey","supabase","createClient","TABLES","useAuthStore","defineStore","user","ref","session","loading","isAuthenticated","computed","userRole","isAdmin","isSales","isViewer","initialize","currentSession","fetchUserProfile","_event","newSession","error","userId","data","authUser","newUser","createdUser","createError","signIn","email","password","signUp","name","profileError","signOut","updateProfile","updates","routes","__vitePreload","router","createRouter","createWebHashHistory","to","from","next","authStore","waitCount","resolve","requiresAuth","record","requiresAdmin","themeOverrides","_createBlock","_unref","NConfigProvider","_createVNode","NMessageProvider","NDialogProvider","NNotificationProvider","_component_router_view","app","createApp","App","pinia","createPinia","naive"],"ignoreList":[],"sources":["../../src/utils/supabase.ts","../../src/stores/auth.ts","../../src/router/index.ts","../../src/App.vue","../../src/main.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n  auth: {\n    persistSession: true,\n    autoRefreshToken: true,\n    detectSessionInUrl: true\n  }\n})\n\n// 数据库表名常量\nexport const TABLES = {\n  CUSTOMERS: 'customers',\n  ORDERS: 'orders',\n  FOLLOWUPS: 'followups',\n  ATTACHMENTS: 'attachments',\n  USERS: 'users'\n} as const\n\n// Storage bucket 名称\nexport const BUCKETS = {\n  ATTACHMENTS: 'attachments'\n} as const\n","import { defineStore } from 'pinia'\nimport { ref, computed } from 'vue'\nimport { supabase } from '@/utils/supabase'\nimport type { User, UserRole } from '@/types'\nimport type { AuthError, Session } from '@supabase/supabase-js'\n\nexport const useAuthStore = defineStore('auth', () => {\n  const user = ref<User | null>(null)\n  const session = ref<Session | null>(null)\n  const loading = ref(false)\n\n  const isAuthenticated = computed(() => !!user.value)\n  const userRole = computed<UserRole>(() => user.value?.role || 'viewer')\n  const isAdmin = computed(() => userRole.value === 'admin')\n  const isSales = computed(() => userRole.value === 'sales')\n  const isViewer = computed(() => userRole.value === 'viewer')\n\n  /**\n   * 初始化认证状态\n   */\n  async function initialize() {\n    loading.value = true\n    try {\n      const {\n        data: { session: currentSession }\n      } = await supabase.auth.getSession()\n\n      if (currentSession) {\n        session.value = currentSession\n        await fetchUserProfile(currentSession.user.id)\n      }\n\n      // 监听认证状态变化\n      supabase.auth.onAuthStateChange(async (_event, newSession) => {\n        session.value = newSession\n        if (newSession?.user) {\n          await fetchUserProfile(newSession.user.id)\n        } else {\n          user.value = null\n        }\n      })\n    } catch (error) {\n      console.error('Failed to initialize auth:', error)\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 获取用户资料\n   */\n  async function fetchUserProfile(userId: string) {\n    try {\n      const { data, error } = await supabase\n        .from('users')\n        .select('*')\n        .eq('id', userId)\n        .maybeSingle()\n\n      if (error) throw error\n\n      // 如果用户记录不存在，自动创建\n      if (!data) {\n        const authUser = (await supabase.auth.getUser()).data.user\n        if (authUser) {\n          const newUser = {\n            id: authUser.id,\n            email: authUser.email!,\n            name: authUser.user_metadata?.name || authUser.email!.split('@')[0],\n            role: 'sales' as const\n          }\n\n          const { data: createdUser, error: createError } = await supabase\n            .from('users')\n            .insert(newUser)\n            .select()\n            .single()\n\n          if (createError) {\n            console.error('Failed to create user profile:', createError)\n          } else {\n            user.value = createdUser\n          }\n        }\n      } else {\n        user.value = data\n      }\n    } catch (error) {\n      console.error('Failed to fetch user profile:', error)\n    }\n  }\n\n  /**\n   * 登录\n   */\n  async function signIn(email: string, password: string): Promise<AuthError | null> {\n    loading.value = true\n    try {\n      const { data, error } = await supabase.auth.signInWithPassword({\n        email,\n        password\n      })\n\n      if (error) return error\n\n      session.value = data.session\n      if (data.user) {\n        await fetchUserProfile(data.user.id)\n      }\n\n      return null\n    } catch (error) {\n      console.error('Sign in error:', error)\n      return error as AuthError\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 注册\n   */\n  async function signUp(\n    email: string,\n    password: string,\n    name?: string\n  ): Promise<AuthError | null> {\n    loading.value = true\n    try {\n      const { data, error } = await supabase.auth.signUp({\n        email,\n        password,\n        options: {\n          data: {\n            name\n          }\n        }\n      })\n\n      if (error) return error\n\n      // 创建用户资料（默认角色为 sales）\n      if (data.user) {\n        const { error: profileError } = await supabase.from('users').insert({\n          id: data.user.id,\n          email: data.user.email!,\n          name: name || email.split('@')[0],\n          role: 'sales'\n        })\n\n        if (profileError) {\n          console.error('Failed to create user profile:', profileError)\n        }\n      }\n\n      return null\n    } catch (error) {\n      console.error('Sign up error:', error)\n      return error as AuthError\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 登出\n   */\n  async function signOut() {\n    loading.value = true\n    try {\n      await supabase.auth.signOut()\n      user.value = null\n      session.value = null\n    } catch (error) {\n      console.error('Sign out error:', error)\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 更新用户资料\n   */\n  async function updateProfile(updates: Partial<User>): Promise<boolean> {\n    if (!user.value) return false\n\n    try {\n      const { error } = await supabase\n        .from('users')\n        .update(updates)\n        .eq('id', user.value.id)\n\n      if (error) throw error\n\n      user.value = { ...user.value, ...updates }\n      return true\n    } catch (error) {\n      console.error('Update profile error:', error)\n      return false\n    }\n  }\n\n  return {\n    user,\n    session,\n    loading,\n    isAuthenticated,\n    userRole,\n    isAdmin,\n    isSales,\n    isViewer,\n    initialize,\n    signIn,\n    signUp,\n    signOut,\n    updateProfile\n  }\n})\n","import { createRouter, createWebHashHistory } from 'vue-router'\nimport type { RouteRecordRaw } from 'vue-router'\nimport { useAuthStore } from '@/stores/auth'\n\nconst routes: RouteRecordRaw[] = [\n  {\n    path: '/login',\n    name: 'Login',\n    component: () => import('@/views/Login.vue'),\n    meta: { requiresAuth: false }\n  },\n  {\n    path: '/',\n    component: () => import('@/layouts/MainLayout.vue'),\n    meta: { requiresAuth: true },\n    children: [\n      {\n        path: '',\n        name: 'Dashboard',\n        component: () => import('@/views/Dashboard.vue')\n      },\n      {\n        path: 'customers',\n        name: 'Customers',\n        component: () => import('@/views/Customers.vue')\n      },\n      {\n        path: 'customers/:id',\n        name: 'CustomerDetail',\n        component: () => import('@/views/CustomerDetail.vue')\n      },\n      {\n        path: 'orders',\n        name: 'Orders',\n        component: () => import('@/views/Orders.vue')\n      },\n      {\n        path: 'reports',\n        name: 'Reports',\n        component: () => import('@/views/Reports.vue')\n      },\n      {\n        path: 'settings',\n        name: 'Settings',\n        component: () => import('@/views/Settings.vue'),\n        meta: { requiresAdmin: true }\n      }\n    ]\n  }\n]\n\nconst router = createRouter({\n  history: createWebHashHistory(),\n  routes\n})\n\n// 路由守卫\nrouter.beforeEach(async (to, from, next) => {\n  const authStore = useAuthStore()\n\n  // 等待认证状态加载完成（最多等待3秒）\n  let waitCount = 0\n  while (authStore.loading && waitCount < 30) {\n    await new Promise(resolve => setTimeout(resolve, 100))\n    waitCount++\n  }\n\n  const requiresAuth = to.matched.some(record => record.meta.requiresAuth !== false)\n  const requiresAdmin = to.matched.some(record => record.meta.requiresAdmin)\n\n  if (requiresAuth && !authStore.isAuthenticated) {\n    // 未登录，跳转到登录页\n    next({ name: 'Login', query: { redirect: to.fullPath } })\n  } else if (requiresAdmin && !authStore.isAdmin) {\n    // 需要管理员权限但不是管理员\n    next({ name: 'Dashboard' })\n  } else if (to.name === 'Login' && authStore.isAuthenticated) {\n    // 已登录，访问登录页时跳转到首页\n    next({ name: 'Dashboard' })\n  } else {\n    next()\n  }\n})\n\nexport default router\n","<template>\n  <n-config-provider :theme-overrides=\"themeOverrides\">\n    <n-message-provider>\n      <n-dialog-provider>\n        <n-notification-provider>\n          <router-view />\n        </n-notification-provider>\n      </n-dialog-provider>\n    </n-message-provider>\n  </n-config-provider>\n</template>\n\n<script setup lang=\"ts\">\nimport { NConfigProvider, NMessageProvider, NDialogProvider, NNotificationProvider } from 'naive-ui'\n\nconst themeOverrides = {\n  common: {\n    primaryColor: '#18a058',\n    primaryColorHover: '#36ad6a',\n    primaryColorPressed: '#0c7a43',\n    primaryColorSuppl: '#36ad6a'\n  }\n}\n</script>\n\n<style>\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,\n    'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol',\n    'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#app {\n  width: 100%;\n  height: 100vh;\n  overflow: hidden;\n}\n</style>\n","import { createApp } from 'vue'\nimport { createPinia } from 'pinia'\nimport router from './router'\nimport App from './App.vue'\nimport { useAuthStore } from './stores/auth'\n\n// 引入 Naive UI\nimport naive from 'naive-ui'\n\nconst app = createApp(App)\nconst pinia = createPinia()\n\napp.use(pinia)\napp.use(router)\napp.use(naive)\n\n// 初始化认证状态\nconst authStore = useAuthStore()\nauthStore.initialize().then(() => {\n  app.mount('#app')\n})\n"],"file":"assets/index-Brpx9w6i.js"}