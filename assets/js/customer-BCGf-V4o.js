import{p as e,r,a as t,s as o,T as a}from"./index-BgS45tSZ.js";const n=e("customer",()=>{const e=r([]),n=r(null),i=r(!1),s=r({page:1,pageSize:20,total:0}),l=t();async function u(r){i.value=!0;try{const t={...r,owner_id:r.owner_id||l.user?.id},{data:n,error:i}=await o.from(a.CUSTOMERS).insert(t).select("*, owner:users!owner_id(id, email, name)").single();if(i)throw i;return e.value.unshift(n),s.value.total++,n}catch(t){throw console.error("Failed to create customer:",t),t}finally{i.value=!1}}return{customers:e,currentCustomer:n,loading:i,pagination:s,fetchCustomers:async function(r,t=1,n=20){i.value=!0;try{let i=o.from(a.CUSTOMERS).select("*, owner:users!owner_id(id, email, name)",{count:"exact"});l.isSales&&l.user&&(i=i.eq("owner_id",l.user.id)),r&&(r.keyword&&(i=i.or(`company.ilike.%${r.keyword}%,contact.ilike.%${r.keyword}%,email.ilike.%${r.keyword}%,phone.ilike.%${r.keyword}%,code.ilike.%${r.keyword}%`)),r.country&&(i=i.eq("country",r.country)),r.status&&(i=i.eq("status",r.status)),void 0!==r.is_entered&&(i=i.eq("is_entered",r.is_entered)),r.owner_id&&(i=i.eq("owner_id",r.owner_id)),r.source&&(i=i.eq("source",r.source)),r.date_from&&(i=i.gte("inquiry_date",r.date_from)),r.date_to&&(i=i.lte("inquiry_date",r.date_to)));const u=(t-1)*n,c=u+n-1,{data:d,error:f,count:w}=await i.order("created_at",{ascending:!1}).range(u,c);if(f)throw f;e.value=d||[],s.value={page:t,pageSize:n,total:w||0}}catch(u){throw console.error("Failed to fetch customers:",u),u}finally{i.value=!1}},fetchCustomerById:async function(e){i.value=!0;try{const{data:r,error:t}=await o.from(a.CUSTOMERS).select("\n          *,\n          owner:users!owner_id(id, email, name),\n          orders(*),\n          followups(*, follower:users!follower_id(id, email, name))\n        ").eq("id",e).single();if(t)throw t;return n.value=r,r}catch(r){return console.error("Failed to fetch customer:",r),null}finally{i.value=!1}},createCustomer:u,updateCustomer:async function(r,t){i.value=!0;try{const{data:i,error:s}=await o.from(a.CUSTOMERS).update(t).eq("id",r).select("*, owner:users!owner_id(id, email, name)").single();if(s)throw s;const l=e.value.findIndex(e=>e.id===r);return-1!==l&&(e.value[l]=i),n.value?.id===r&&(n.value={...n.value,...i}),!0}catch(s){throw console.error("Failed to update customer:",s),s}finally{i.value=!1}},deleteCustomer:async function(r){i.value=!0;try{const{error:t}=await o.from(a.CUSTOMERS).delete().eq("id",r);if(t)throw t;return e.value=e.value.filter(e=>e.id!==r),s.value.total--,n.value?.id===r&&(n.value=null),!0}catch(t){throw console.error("Failed to delete customer:",t),t}finally{i.value=!1}},importCustomers:async function(e){const r={success:0,failed:0,errors:[]};for(let o=0;o<e.length;o++)try{await u(e[o]),r.success++}catch(t){r.failed++,r.errors.push({index:o,error:t instanceof Error?t.message:"未知错误"})}return r}}});export{n as u};
