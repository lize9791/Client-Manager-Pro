import{_ as pe}from"./index-B9Y8Dfba.js";import{k as W,a0 as g,Y as u,a3 as c,c as R,r as f,W as C,Z as o,N as t,_ as s,a7 as w,j as p,a8 as ce,F as ee,R as te,a5 as X,e as ve,o as me,m as U,a1 as fe}from"./vue-vendor-ChRmxV0E.js";import{u as ne}from"./customer-C2CVYkh1.js";import{d as ye,f as we}from"./helpers-CM6_8sGB.js";import{_ as ke}from"./CustomerFormModal.vue_vue_type_script_setup_true_lang-T76RGBAc.js";import{read as be,utils as T,writeFile as ge}from"./excel-CPbvKKXA.js";import{u as re,H as he,I as L,J as _e,K as le,L as xe,j as Z,E as Ce,M as ae,O as Se,P as Y,h as Ne,Q as A,g as qe,R as ie,y as O,S as se,T as Ue,U as Me,v as De,w as Ee,V as Ie,B as h,W as ze,d as Fe,i as oe,z as Oe,X as je,q as $e}from"./naive-ui-C-WnQlxP.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Be}from"./SearchOutline-DUsqMxOm.js";import"./supabase-BxUUOEWR.js";const Ve={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Pe=W({name:"CloudUploadOutline",render:function(E,k){return u(),g("svg",Ve,k[0]||(k[0]=[c("path",{d:"M320 367.79h76c55 0 100-29.21 100-83.6s-53-81.47-96-83.6c-8.89-85.06-71-136.8-144-136.8c-69 0-113.44 45.79-128 91.2c-60 5.7-112 43.88-112 106.4s54 106.4 120 106.4h56",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M320 255.79l-64-64l-64 64"},null,-1),c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 448.21V207.79"},null,-1)]))}}),Te={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Le=W({name:"EllipsisVerticalOutline",render:function(E,k){return u(),g("svg",Te,k[0]||(k[0]=[c("circle",{cx:"256",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),c("circle",{cx:"256",cy:"416",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),c("circle",{cx:"256",cy:"96",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),Re={key:0,class:"step-content"},Ae={style:{"margin-bottom":"12px"}},We={key:1,class:"step-content"},He={key:2,class:"step-content"},Je={key:3,class:"step-content"},Ke=W({__name:"ImportModal",props:{show:{type:Boolean}},emits:["update:show","success"],setup(j,{emit:E}){const k=j,b=E,r=re(),S=ne(),M=R({get:()=>k.show,set:l=>b("update:show",l)}),n=f(1),d=f("process"),I=f(!1),D=f([]),z=f([]),_=f({}),x=f([]),v=f({success:0,failed:0,errors:[]}),N=[{key:"code",label:"客户单号",required:!0},{key:"company",label:"公司名称",required:!0},{key:"contact",label:"联系人",required:!0},{key:"country",label:"国家/地区",required:!0},{key:"product",label:"产品",required:!0},{key:"inquiry_date",label:"询盘日期",required:!0},{key:"email",label:"邮箱",required:!1},{key:"phone",label:"电话",required:!1},{key:"source",label:"客户来源",required:!1},{key:"remark",label:"备注",required:!1}],y=R(()=>[{title:"公司",key:"company"},{title:"联系人",key:"contact"},{title:"国家",key:"country"},{title:"产品",key:"product"},{title:"邮箱",key:"email"},{title:"询盘日期",key:"inquiry_date"}]),$=R(()=>n.value===1?D.value.length>0:n.value===2?N.filter(e=>e.required).every(e=>_.value[e.key]):!0);async function H(l){const{file:e}=l;try{const a=await e.file?.arrayBuffer();if(!a)throw new Error("文件读取失败");const m=be(a),P=m.Sheets[m.SheetNames[0]],F=T.sheet_to_json(P,{raw:!1});if(F.length===0)throw new Error("文件中没有数据");D.value=F;const i=Object.keys(F[0]);z.value=i.map(q=>({label:q,value:q})),N.forEach(q=>{const G=i.find(de=>de.toLowerCase().includes(q.label.toLowerCase()));G&&(_.value[q.key]=G)}),r.success("文件上传成功"),n.value=2}catch(a){r.error("文件解析失败："+a.message)}}function B(){n.value===2&&(x.value=D.value.map(l=>{const e={};return Object.entries(_.value).forEach(([a,m])=>{m&&(e[a]=l[m])}),e})),n.value++}function J(){n.value--}async function K(){I.value=!0;try{const l=x.value.map(a=>({...a,status:"new",source:a.source||"other",is_entered:!1})),e=await S.importCustomers(l);v.value=e,n.value=4,d.value=e.failed===0?"finish":"error",e.failed===0?(r.success(`成功导入 ${e.success} 条数据`),b("success")):r.warning(`导入完成：成功 ${e.success} 条，失败 ${e.failed} 条`)}catch(l){r.error("导入失败："+l.message),d.value="error"}finally{I.value=!1}}function Q(){const l=[{客户单号:"CUS20240101001",公司名称:"示例公司 Inc.",联系人:"张三","国家/地区":"美国",产品:"示例产品",询盘日期:"2024-01-01",邮箱:"example@company.com",电话:"+1-234-567-8900",客户来源:"website",备注:"这是一条示例数据"}],e=T.json_to_sheet(l),a=T.book_new();T.book_append_sheet(a,e,"客户导入模板"),ge(a,"客户导入模板.xlsx"),r.success("模板下载成功")}function V(){n.value=1,d.value="process",D.value=[],z.value=[],_.value={},x.value=[],v.value={success:0,failed:0,errors:[]},b("update:show",!1)}return(l,e)=>(u(),C(t(he),{show:M.value,"onUpdate:show":e[0]||(e[0]=a=>M.value=a),"mask-closable":!1,preset:"card",title:"导入客户数据",style:{width:"900px"}},{footer:o(()=>[s(t(O),{justify:"end"},{default:o(()=>[n.value>1&&n.value<4?(u(),C(t(h),{key:0,onClick:J},{default:o(()=>[...e[10]||(e[10]=[p(" 上一步 ",-1)])]),_:1})):w("",!0),n.value<3?(u(),C(t(h),{key:1,type:"primary",disabled:!$.value,onClick:B},{default:o(()=>[...e[11]||(e[11]=[p(" 下一步 ",-1)])]),_:1},8,["disabled"])):w("",!0),n.value===3?(u(),C(t(h),{key:2,type:"primary",loading:I.value,onClick:K},{default:o(()=>[...e[12]||(e[12]=[p(" 开始导入 ",-1)])]),_:1},8,["loading"])):w("",!0),n.value===4?(u(),C(t(h),{key:3,type:"primary",onClick:V},{default:o(()=>[...e[13]||(e[13]=[p(" 完成 ",-1)])]),_:1})):w("",!0),s(t(h),{onClick:V},{default:o(()=>[...e[14]||(e[14]=[p("取消",-1)])]),_:1})]),_:1})]),default:o(()=>[s(t(_e),{current:n.value,status:d.value},{default:o(()=>[s(t(L),{title:"上传文件"}),s(t(L),{title:"列映射"}),s(t(L),{title:"预览确认"}),s(t(L),{title:"导入结果"})]),_:1},8,["current","status"]),s(t(le)),n.value===1?(u(),g("div",Re,[s(t(Se),{"custom-request":H,"show-file-list":!1,accept:".xlsx,.xls,.csv"},{default:o(()=>[s(t(xe),null,{default:o(()=>[c("div",Ae,[s(t(Z),{size:"48",depth:3},{default:o(()=>[s(t(Pe))]),_:1})]),s(t(Ce),{style:{"font-size":"16px"}},{default:o(()=>[...e[1]||(e[1]=[p(" 点击或拖拽文件到此区域上传 ",-1)])]),_:1}),s(t(ae),{depth:"3",style:{margin:"8px 0 0 0"}},{default:o(()=>[...e[2]||(e[2]=[p(" 支持 .xlsx, .xls, .csv 格式，单个文件不超过 10MB ",-1)])]),_:1})]),_:1})]),_:1}),s(t(le)),s(t(Y),{type:"info",title:"导入说明"},{default:o(()=>[c("ul",null,[e[5]||(e[5]=c("li",null,"支持 Excel (.xlsx, .xls) 和 CSV 格式",-1)),e[6]||(e[6]=c("li",null,"第一行应为列标题",-1)),e[7]||(e[7]=c("li",null,"必填字段：公司名称、联系人、国家、产品、询盘日期",-1)),c("li",null,[e[3]||(e[3]=p("下载 ",-1)),c("a",{href:"#",onClick:ce(Q,["prevent"])},"导入模板"),e[4]||(e[4]=p(" 查看格式",-1))])])]),_:1})])):w("",!0),n.value===2?(u(),g("div",We,[s(t(Y),{type:"info",title:"列映射",style:{"margin-bottom":"16px"}},{default:o(()=>[...e[8]||(e[8]=[p(" 请将 Excel 列名映射到系统字段 ",-1)])]),_:1}),s(t(qe),{"label-placement":"left","label-width":"120px"},{default:o(()=>[(u(),g(ee,null,te(N,a=>s(t(Ne),{key:a.key,label:a.label,required:a.required},{default:o(()=>[s(t(A),{value:_.value[a.key],"onUpdate:value":m=>_.value[a.key]=m,options:z.value,placeholder:"选择对应的 Excel 列",clearable:""},null,8,["value","onUpdate:value","options"])]),_:2},1032,["label","required"])),64))]),_:1})])):w("",!0),n.value===3?(u(),g("div",He,[s(t(Y),{type:"warning",title:"数据预览",style:{"margin-bottom":"16px"}},{default:o(()=>[p(" 共 "+X(x.value.length)+" 条数据，请确认无误后导入 ",1)]),_:1}),s(t(ie),{columns:y.value,data:x.value.slice(0,10),"max-height":400,pagination:!1},null,8,["columns","data"]),x.value.length>10?(u(),C(t(ae),{key:0,depth:"3",style:{"margin-top":"8px"}},{default:o(()=>[...e[9]||(e[9]=[p(" 仅显示前 10 条数据预览 ",-1)])]),_:1})):w("",!0)])):w("",!0),n.value===4?(u(),g("div",Je,[s(t(Ie),{status:v.value.failed===0?"success":"warning",title:v.value.failed===0?"导入完成":"导入完成（部分失败）"},{footer:o(()=>[s(t(O),{vertical:""},{default:o(()=>[s(t(se),{label:"成功",value:v.value.success},null,8,["value"]),s(t(se),{label:"失败",value:v.value.failed},null,8,["value"]),v.value.errors.length>0?(u(),C(t(Ue),{key:0},{default:o(()=>[s(t(Me),{title:"查看错误详情",name:"errors"},{default:o(()=>[s(t(De),null,{default:o(()=>[(u(!0),g(ee,null,te(v.value.errors,a=>(u(),C(t(Ee),{key:a.index},{default:o(()=>[p(" 第 "+X(a.index+1)+" 行: "+X(a.error),1)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})):w("",!0)]),_:1})]),_:1},8,["status","title"])])):w("",!0)]),_:1},8,["show"]))}}),Qe=ue(Ke,[["__scopeId","data-v-e1494b21"]]),Xe={class:"customers-view"},Ye=W({__name:"Customers",setup(j){const E=fe(),k=ze(),b=re(),r=ne(),S=f(!1),M=f(!1),n=f(null),d=ve({keyword:"",status:void 0,source:void 0,country:"",is_entered:void 0}),I=[{label:"样品已成交",value:"sample_won"},{label:"洽谈中",value:"negotiating"},{label:"排产中",value:"in_production"},{label:"已完成",value:"completed"},{label:"新一轮洽谈",value:"new_round"},{label:"已被他人成交",value:"won_by_others"},{label:"潜在客户",value:"potential"},{label:"高价值客户",value:"high_value"},{label:"无回复",value:"no_response"},{label:"不可执行",value:"not_executable"},{label:"低优先级",value:"low_priority"}],D=[{label:"网站",value:"website"},{label:"邮件",value:"email"},{label:"展会",value:"exhibition"},{label:"转介绍",value:"referral"},{label:"电话营销",value:"cold_call"},{label:"社交媒体",value:"social_media"},{label:"其他",value:"other"}],z=[{label:"已录入",value:!0},{label:"未录入",value:!1}],_=[{title:"单号",key:"code",width:150,fixed:"left",render:l=>U("a",{onClick:()=>B(l)},l.code)},{title:"公司",key:"company",width:200,ellipsis:{tooltip:!0}},{title:"联系人",key:"contact",width:120},{title:"国家",key:"country",width:100},{title:"产品",key:"product",width:150,ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:120,render:l=>{const e={sample_won:{type:"success",label:"样品已成交"},negotiating:{type:"info",label:"洽谈中"},in_production:{type:"warning",label:"排产中"},completed:{type:"success",label:"已完成"},new_round:{type:"info",label:"新一轮洽谈"},won_by_others:{type:"error",label:"已被他人成交"},potential:{type:"default",label:"潜在客户"},high_value:{type:"success",label:"高价值客户"},no_response:{type:"warning",label:"无回复"},not_executable:{type:"error",label:"不可执行"},low_priority:{type:"default",label:"低优先级"}},{type:a,label:m}=e[l.status]||{type:"default",label:l.status};return U(Oe,{type:a,size:"small"},{default:()=>m})}},{title:"是否录入",key:"is_entered",width:100,render:l=>U(je,{value:l.is_entered,disabled:!0})},{title:"询盘日期",key:"inquiry_date",width:120,render:l=>we(l.inquiry_date)},{title:"负责人",key:"owner",width:120,render:l=>l.owner?.name||l.owner?.email||"-"},{title:"操作",key:"actions",width:80,fixed:"right",render:l=>U($e,{options:[{label:"查看",key:"view"},{label:"编辑",key:"edit"},{label:"删除",key:"delete"}],onSelect:e=>J(e,l)},{default:()=>U(h,{text:!0},{icon:()=>U(Z,null,{default:()=>U(Le)})})})}],x=R(()=>({page:r.pagination.page,pageSize:r.pagination.pageSize,pageCount:Math.ceil(r.pagination.total/r.pagination.pageSize),showSizePicker:!0,pageSizes:[10,20,50,100],onChange:l=>$(l),onUpdatePageSize:l=>H(l)})),v=ye(()=>{y()},500);function N(){y()}async function y(l){try{await r.fetchCustomers(d,l||r.pagination.page,r.pagination.pageSize)}catch(e){b.error(e?.message||"加载客户列表失败")}}function $(l){y(l)}function H(l){r.pagination.pageSize=l,y(1)}function B(l){E.push({name:"CustomerDetail",params:{id:l.id}})}function J(l,e){switch(l){case"view":B(e);break;case"edit":n.value=e,S.value=!0;break;case"delete":K(e);break}}function K(l){k.warning({title:"确认删除",content:`确定要删除客户 "${l.company}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await r.deleteCustomer(l.id),b.success("删除成功"),y()}catch(e){b.error(e?.message||"删除失败")}}})}function Q(){S.value=!1,n.value=null,y()}async function V(){try{const{utils:l,writeFile:e}=await pe(async()=>{const{utils:i,writeFile:q}=await import("./excel-CPbvKKXA.js");return{utils:i,writeFile:q}},[]),a=r.customers.map(i=>({单号:i.code,公司:i.company,联系人:i.contact,国家:i.country,产品:i.product,邮箱:i.email,电话:i.phone,状态:i.status,来源:i.source,询盘日期:i.inquiry_date,是否录入:i.is_entered?"是":"否",备注:i.remark})),m=l.json_to_sheet(a),P=l.book_new();l.book_append_sheet(P,m,"客户列表");const F=`customers_${new Date().toISOString().split("T")[0]}.xlsx`;e(P,F),b.success("导出成功")}catch(l){b.error("导出失败："+l.message)}}return me(()=>{y()}),(l,e)=>(u(),g("div",Xe,[s(t(Fe),{title:"客户管理"},{"header-extra":o(()=>[s(t(O),null,{default:o(()=>[s(t(h),{type:"primary",onClick:e[0]||(e[0]=a=>S.value=!0)},{default:o(()=>[...e[9]||(e[9]=[p("新增客户",-1)])]),_:1}),s(t(h),{onClick:e[1]||(e[1]=a=>M.value=!0)},{default:o(()=>[...e[10]||(e[10]=[p("导入",-1)])]),_:1}),s(t(h),{onClick:V},{default:o(()=>[...e[11]||(e[11]=[p("导出",-1)])]),_:1})]),_:1})]),default:o(()=>[s(t(O),{vertical:"",size:"large"},{default:o(()=>[s(t(O),null,{default:o(()=>[s(t(oe),{value:d.keyword,"onUpdate:value":[e[2]||(e[2]=a=>d.keyword=a),t(v)],placeholder:"搜索公司/联系人/邮箱/电话/单号",clearable:"",style:{width:"300px"}},{prefix:o(()=>[s(t(Z),{component:t(Be)},null,8,["component"])]),_:1},8,["value","onUpdate:value"]),s(t(A),{value:d.status,"onUpdate:value":[e[3]||(e[3]=a=>d.status=a),N],placeholder:"状态",clearable:"",style:{width:"150px"},options:I},null,8,["value"]),s(t(A),{value:d.source,"onUpdate:value":[e[4]||(e[4]=a=>d.source=a),N],placeholder:"来源",clearable:"",style:{width:"150px"},options:D},null,8,["value"]),s(t(oe),{value:d.country,"onUpdate:value":[e[5]||(e[5]=a=>d.country=a),t(v)],placeholder:"国家",clearable:"",style:{width:"150px"}},null,8,["value","onUpdate:value"]),s(t(A),{value:d.is_entered,"onUpdate:value":[e[6]||(e[6]=a=>d.is_entered=a),N],placeholder:"是否录入",clearable:"",style:{width:"150px"},options:z},null,8,["value"])]),_:1}),s(t(ie),{columns:_,data:t(r).customers,loading:t(r).loading,pagination:x.value,"row-key":a=>a.id,"onUpdate:page":$},null,8,["data","loading","pagination","row-key"])]),_:1})]),_:1}),s(ke,{show:S.value,"onUpdate:show":e[7]||(e[7]=a=>S.value=a),customer:n.value,onSuccess:Q},null,8,["show","customer"]),s(Qe,{show:M.value,"onUpdate:show":e[8]||(e[8]=a=>M.value=a),onSuccess:y},null,8,["show"])]))}}),it=ue(Ye,[["__scopeId","data-v-62df579c"]]);export{it as default};
