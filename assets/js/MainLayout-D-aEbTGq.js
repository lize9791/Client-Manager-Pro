import{k as O,a0 as _,a3 as d,Y as f,S as T,r as y,c as U,a4 as V,m as p,o as I,W as N,Z as n,N as e,_ as l,a2 as W,j as b,a5 as A,X as E,R as H,F as K,a1 as X}from"./vue-vendor-ChRmxV0E.js";import{u as z,s as S,T as C}from"./index-LEjS_y3d.js";import{f as Y}from"./helpers-CM6_8sGB.js";import{_ as Z}from"./CustomerFormModal.vue_vue_type_script_setup_true_lang-C6TDuDX5.js";import{j as w,k as j,l as G,m as J,o as Q,i as ee,B,p as te,q as oe,r as le,s as ne,t as ae,v as re,w as se,x as ie,y as ue,z as de,A as ce}from"./naive-ui-C-WnQlxP.js";import{P as pe,S as fe,N as me}from"./StatsChartOutline-MKDoyLsD.js";import{D as we,A as he}from"./DocumentTextOutline-DEN2-gad.js";import{S as ve}from"./SearchOutline-DUsqMxOm.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./supabase-BxUUOEWR.js";import"./customer-DlWSUBeS.js";const _e={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ge=O({name:"HomeOutline",render:function(a,r){return f(),_("svg",_e,r[0]||(r[0]=[d("path",{d:"M80 212v236a16 16 0 0 0 16 16h96V328a24 24 0 0 1 24-24h80a24 24 0 0 1 24 24v136h96a16 16 0 0 0 16-16V212",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),d("path",{d:"M480 256L266.89 52c-5-5.28-16.69-5.34-21.78 0L32 256",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),d("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M400 179V64h-48v69"},null,-1)]))}}),ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},xe=O({name:"LogOutOutline",render:function(a,r){return f(),_("svg",ke,r[0]||(r[0]=[d("path",{d:"M304 336v40a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V136a40 40 0 0 1 40-40h152c22.09 0 48 17.91 48 40v40",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),d("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M368 336l80-80l-80-80"},null,-1),d("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M176 256h256"},null,-1)]))}}),Se={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Ce=O({name:"PersonCircleOutline",render:function(a,r){return f(),_("svg",Se,r[0]||(r[0]=[d("path",{d:"M258.9 48C141.92 46.42 46.42 141.92 48 258.9c1.56 112.19 92.91 203.54 205.1 205.1c117 1.6 212.48-93.9 210.88-210.88C462.44 140.91 371.09 49.56 258.9 48zm126.42 327.25a4 4 0 0 1-6.14-.32a124.27 124.27 0 0 0-32.35-29.59C321.37 329 289.11 320 256 320s-65.37 9-90.83 25.34a124.24 124.24 0 0 0-32.35 29.58a4 4 0 0 1-6.14.32A175.32 175.32 0 0 1 80 259c-1.63-97.31 78.22-178.76 175.57-179S432 158.81 432 256a175.32 175.32 0 0 1-46.68 119.25z",fill:"currentColor"},null,-1),d("path",{d:"M256 144c-19.72 0-37.55 7.39-50.22 20.82s-19 32-17.57 51.93C191.11 256 221.52 288 256 288s64.83-32 67.79-71.24c1.48-19.74-4.8-38.14-17.68-51.82C293.39 151.44 275.59 144 256 144z",fill:"currentColor"},null,-1)]))}}),Oe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Le=O({name:"SettingsOutline",render:function(a,r){return f(),_("svg",Oe,r[0]||(r[0]=[d("path",{d:"M262.29 192.31a64 64 0 1 0 57.4 57.4a64.13 64.13 0 0 0-57.4-57.4zM416.39 256a154.34 154.34 0 0 1-1.53 20.79l45.21 35.46a10.81 10.81 0 0 1 2.45 13.75l-42.77 74a10.81 10.81 0 0 1-13.14 4.59l-44.9-18.08a16.11 16.11 0 0 0-15.17 1.75A164.48 164.48 0 0 1 325 400.8a15.94 15.94 0 0 0-8.82 12.14l-6.73 47.89a11.08 11.08 0 0 1-10.68 9.17h-85.54a11.11 11.11 0 0 1-10.69-8.87l-6.72-47.82a16.07 16.07 0 0 0-9-12.22a155.3 155.3 0 0 1-21.46-12.57a16 16 0 0 0-15.11-1.71l-44.89 18.07a10.81 10.81 0 0 1-13.14-4.58l-42.77-74a10.8 10.8 0 0 1 2.45-13.75l38.21-30a16.05 16.05 0 0 0 6-14.08c-.36-4.17-.58-8.33-.58-12.5s.21-8.27.58-12.35a16 16 0 0 0-6.07-13.94l-38.19-30A10.81 10.81 0 0 1 49.48 186l42.77-74a10.81 10.81 0 0 1 13.14-4.59l44.9 18.08a16.11 16.11 0 0 0 15.17-1.75A164.48 164.48 0 0 1 187 111.2a15.94 15.94 0 0 0 8.82-12.14l6.73-47.89A11.08 11.08 0 0 1 213.23 42h85.54a11.11 11.11 0 0 1 10.69 8.87l6.72 47.82a16.07 16.07 0 0 0 9 12.22a155.3 155.3 0 0 1 21.46 12.57a16 16 0 0 0 15.11 1.71l44.89-18.07a10.81 10.81 0 0 1 13.14 4.58l42.77 74a10.8 10.8 0 0 1-2.45 13.75l-38.21 30a16.05 16.05 0 0 0-6.05 14.08c.33 4.14.55 8.3.55 12.47z",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1)]))}}),Ne=T("followup",()=>{const c=y([]),a=y(!1),r=z();async function g(o){a.value=!0;try{let t=S.from(C.FOLLOWUPS).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)");o&&(t=t.eq("customer_id",o));const{data:s,error:m}=await t.order("follow_date",{ascending:!1});if(m)throw m;c.value=s||[]}catch(t){throw console.error("Failed to fetch followups:",t),t}finally{a.value=!1}}async function M(o){a.value=!0;try{const t={...o,follower_id:o.follower_id||r.user?.id},{data:s,error:m}=await S.from(C.FOLLOWUPS).insert(t).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").single();if(m)throw m;return c.value.unshift(s),o.customer_id&&await S.from(C.CUSTOMERS).update({last_follow_date:o.follow_date}).eq("id",o.customer_id),s}catch(t){throw console.error("Failed to create followup:",t),t}finally{a.value=!1}}async function h(o,t){a.value=!0;try{const{data:s,error:m}=await S.from(C.FOLLOWUPS).update(t).eq("id",o).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").single();if(m)throw m;const L=c.value.findIndex(F=>F.id===o);return L!==-1&&(c.value[L]=s),!0}catch(s){throw console.error("Failed to update followup:",s),s}finally{a.value=!1}}async function k(o){a.value=!0;try{const{error:t}=await S.from(C.FOLLOWUPS).delete().eq("id",o);if(t)throw t;return c.value=c.value.filter(s=>s.id!==o),!0}catch(t){throw console.error("Failed to delete followup:",t),t}finally{a.value=!1}}async function x(){try{const o=new Date().toISOString().split("T")[0],{data:t,error:s}=await S.from(C.FOLLOWUPS).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").lte("remind_at",o).not("remind_at","is",null).order("remind_at",{ascending:!0});if(s)throw s;return t||[]}catch(o){return console.error("Failed to fetch pending reminders:",o),[]}}return{followups:c,loading:a,fetchFollowups:g,createFollowup:M,updateFollowup:h,deleteFollowup:k,fetchPendingReminders:x}}),Me={class:"logo"},Fe={key:0},be={key:1},Ae={style:{display:"flex","align-items":"center",gap:"16px"}},Be={style:{display:"flex","align-items":"center",gap:"16px"}},Pe=O({__name:"MainLayout",setup(c){const a=X(),r=V(),g=z(),M=Ne(),h=y(!1),k=y(""),x=y(!1),o=y(!1),t=y([]),s=U(()=>r.name),m=U(()=>{const v=[{label:"仪表盘",key:"Dashboard",icon:()=>p(w,null,{default:()=>p(ge)})},{label:"客户管理",key:"Customers",icon:()=>p(w,null,{default:()=>p(pe)})},{label:"订单管理",key:"Orders",icon:()=>p(w,null,{default:()=>p(we)})},{label:"统计报表",key:"Reports",icon:()=>p(w,null,{default:()=>p(fe)})}];return g.isAdmin&&v.push({label:"系统设置",key:"Settings",icon:()=>p(w,null,{default:()=>p(Le)})}),v}),L=[{label:"退出登录",key:"logout",icon:()=>p(w,null,{default:()=>p(xe)})}];function F(v){a.push({name:v})}function R(){k.value&&a.push({name:"Customers",query:{keyword:k.value}})}function D(v){v==="logout"&&(g.signOut(),a.push({name:"Login"}))}function $(){x.value=!1,r.name==="Customers"&&a.go(0)}async function P(){t.value=await M.fetchPendingReminders()}return I(()=>{P(),setInterval(P,5*60*1e3)}),(v,i)=>{const q=E("router-view");return f(),N(e(j),{"has-sider":"",style:{height:"100vh"}},{default:n(()=>[l(e(J),{bordered:"","collapse-mode":"width","collapsed-width":64,width:240,collapsed:h.value,"show-trigger":"",onCollapse:i[0]||(i[0]=u=>h.value=!0),onExpand:i[1]||(i[1]=u=>h.value=!1)},{default:n(()=>[d("div",Me,[h.value?(f(),_("h2",be,"CRM")):(f(),_("h2",Fe,"客户管理系统"))]),l(e(G),{collapsed:h.value,"collapsed-width":64,"collapsed-icon-size":22,options:m.value,value:s.value,"onUpdate:value":F},null,8,["collapsed","options","value"])]),_:1},8,["collapsed"]),l(e(j),null,{default:n(()=>[l(e(Q),{bordered:"",style:{height:"64px",padding:"0 24px",display:"flex","align-items":"center","justify-content":"space-between"}},{default:n(()=>[d("div",Ae,[l(e(ee),{value:k.value,"onUpdate:value":i[2]||(i[2]=u=>k.value=u),placeholder:"搜索客户...",clearable:"",style:{width:"300px"},onKeyup:W(R,["enter"])},{prefix:n(()=>[l(e(w),{component:e(ve)},null,8,["component"])]),_:1},8,["value"]),l(e(B),{type:"primary",onClick:i[3]||(i[3]=u=>x.value=!0)},{icon:n(()=>[l(e(w),{component:e(he)},null,8,["component"])]),default:n(()=>[i[7]||(i[7]=b(" 新增客户 ",-1))]),_:1})]),d("div",Be,[l(e(te),{value:t.value.length,max:99},{default:n(()=>[l(e(B),{circle:"",quaternary:"",onClick:i[4]||(i[4]=u=>o.value=!0)},{icon:n(()=>[l(e(w),{component:e(me)},null,8,["component"])]),_:1})]),_:1},8,["value"]),l(e(oe),{options:L,onSelect:D},{default:n(()=>[l(e(B),{text:"",style:{"font-size":"14px"}},{icon:n(()=>[l(e(w),{component:e(Ce)},null,8,["component"])]),default:n(()=>[b(" "+A(e(g).user?.name||e(g).user?.email),1)]),_:1})]),_:1})])]),_:1}),l(e(le),{"content-style":"padding: 24px;","native-scrollbar":!1},{default:n(()=>[l(q)]),_:1})]),_:1}),l(Z,{show:x.value,"onUpdate:show":i[5]||(i[5]=u=>x.value=u),onSuccess:$},null,8,["show"]),l(e(ce),{show:o.value,"onUpdate:show":i[6]||(i[6]=u=>o.value=u),width:400,placement:"right"},{default:n(()=>[l(e(ne),{title:"待办提醒",closable:""},{default:n(()=>[t.value.length===0?(f(),N(e(ae),{key:0,description:"暂无待办提醒"})):(f(),N(e(re),{key:1},{default:n(()=>[(f(!0),_(K,null,H(t.value,u=>(f(),N(e(se),{key:u.id},{default:n(()=>[l(e(ie),{title:u.customer?.company||"未知客户"},{description:n(()=>[l(e(ue),{vertical:"",size:"small"},{default:n(()=>[d("span",null,A(u.content),1),l(e(de),{size:"small",type:"warning"},{default:n(()=>[b(" 提醒时间: "+A(e(Y)(u.remind_at)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1},8,["show"])]),_:1})}}}),Ee=ye(Pe,[["__scopeId","data-v-ee2b0f31"]]);export{Ee as default};
