import{_ as e}from"./index-BcVpiwTF.js";import{k as l,a0 as a,Y as t,a3 as s,c as o,r,W as i,Z as n,N as u,_ as c,a7 as d,j as p,a8 as v,F as y,R as f,a5 as m,e as w,o as h,m as _,a1 as k}from"./vue-vendor-AGKXruha.js";import{u as b}from"./customer-DFMcG-Vh.js";import{d as g,f as x}from"./helpers-Ba1kvV6f.js";import{_ as C}from"./CustomerFormModal.vue_vue_type_script_setup_true_lang-CNOHx8k1.js";import{read as j,utils as q,writeFile as S}from"./excel-C3s_O8KD.js";import{u as U,H as z,I as E,J as M,K as O,L as I,j as B,E as F,M as P,O as T,P as V,h as $,Q as L,g as D,R,y as N,S as W,T as A,U as H,v as J,w as K,V as Q,B as X,W as Y,d as Z,i as G,z as ee,X as le,q as ae}from"./naive-ui-DL6zjJD3.js";import{_ as te}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{S as se}from"./SearchOutline-C3SMgW99.js";import"./supabase-BUHeOf8C.js";const oe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},re=l({name:"CloudUploadOutline",render:function(e,l){return t(),a("svg",oe,l[0]||(l[0]=[s("path",{d:"M320 367.79h76c55 0 100-29.21 100-83.6s-53-81.47-96-83.6c-8.89-85.06-71-136.8-144-136.8c-69 0-113.44 45.79-128 91.2c-60 5.7-112 43.88-112 106.4s54 106.4 120 106.4h56",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),s("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M320 255.79l-64-64l-64 64"},null,-1),s("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 448.21V207.79"},null,-1)]))}}),ie={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ne=l({name:"EllipsisVerticalOutline",render:function(e,l){return t(),a("svg",ie,l[0]||(l[0]=[s("circle",{cx:"256",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),s("circle",{cx:"256",cy:"416",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),s("circle",{cx:"256",cy:"96",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),ue={key:0,class:"step-content"},ce={style:{"margin-bottom":"12px"}},de={key:1,class:"step-content"},pe={key:2,class:"step-content"},ve={key:3,class:"step-content"},ye=te(l({__name:"ImportModal",props:{show:{type:Boolean}},emits:["update:show","success"],setup(e,{emit:l}){const w=e,h=l,_=U(),k=b(),g=o({get:()=>w.show,set:e=>h("update:show",e)}),x=r(1),C=r("process"),Y=r(!1),Z=r([]),G=r([]),ee=r({}),le=r([]),ae=r({success:0,failed:0,errors:[]}),te=[{key:"code",label:"客户单号",required:!0},{key:"company",label:"公司名称",required:!0},{key:"contact",label:"联系人",required:!0},{key:"country",label:"国家/地区",required:!0},{key:"product",label:"产品",required:!0},{key:"inquiry_date",label:"询盘日期",required:!0},{key:"email",label:"邮箱",required:!1},{key:"phone",label:"电话",required:!1},{key:"source",label:"客户来源",required:!1},{key:"remark",label:"备注",required:!1}],se=o(()=>[{title:"公司",key:"company"},{title:"联系人",key:"contact"},{title:"国家",key:"country"},{title:"产品",key:"product"},{title:"邮箱",key:"email"},{title:"询盘日期",key:"inquiry_date"}]),oe=o(()=>{if(1===x.value)return Z.value.length>0;if(2===x.value){return te.filter(e=>e.required).every(e=>ee.value[e.key])}return!0});async function ie(e){const{file:l}=e;try{const e=await(l.file?.arrayBuffer());if(!e)throw new Error("文件读取失败");const a=j(e),t=a.Sheets[a.SheetNames[0]],s=q.sheet_to_json(t,{raw:!1});if(0===s.length)throw new Error("文件中没有数据");Z.value=s;const o=Object.keys(s[0]);G.value=o.map(e=>({label:e,value:e})),te.forEach(e=>{const l=o.find(l=>l.toLowerCase().includes(e.label.toLowerCase()));l&&(ee.value[e.key]=l)}),_.success("文件上传成功"),x.value=2}catch(a){_.error("文件解析失败："+a.message)}}function ne(){2===x.value&&(le.value=Z.value.map(e=>{const l={};return Object.entries(ee.value).forEach(([a,t])=>{t&&(l[a]=e[t])}),l})),x.value++}function ye(){x.value--}async function fe(){Y.value=!0;try{const e=le.value.map(e=>({...e,status:"new",source:e.source||"other",is_entered:!1})),l=await k.importCustomers(e);ae.value=l,x.value=4,C.value=0===l.failed?"finish":"error",0===l.failed?(_.success(`成功导入 ${l.success} 条数据`),h("success")):_.warning(`导入完成：成功 ${l.success} 条，失败 ${l.failed} 条`)}catch(e){_.error("导入失败："+e.message),C.value="error"}finally{Y.value=!1}}function me(){const e=q.json_to_sheet([{"客户单号":"CUS20240101001","公司名称":"示例公司 Inc.","联系人":"张三","国家/地区":"美国","产品":"示例产品","询盘日期":"2024-01-01","邮箱":"example@company.com","电话":"+1-234-567-8900","客户来源":"website","备注":"这是一条示例数据"}]),l=q.book_new();q.book_append_sheet(l,e,"客户导入模板"),S(l,"客户导入模板.xlsx"),_.success("模板下载成功")}function we(){x.value=1,C.value="process",Z.value=[],G.value=[],ee.value={},le.value=[],ae.value={success:0,failed:0,errors:[]},h("update:show",!1)}return(e,l)=>(t(),i(u(z),{show:g.value,"onUpdate:show":l[0]||(l[0]=e=>g.value=e),"mask-closable":!1,preset:"card",title:"导入客户数据",style:{width:"900px"}},{footer:n(()=>[c(u(N),{justify:"end"},{default:n(()=>[x.value>1&&x.value<4?(t(),i(u(X),{key:0,onClick:ye},{default:n(()=>[...l[10]||(l[10]=[p(" 上一步 ",-1)])]),_:1})):d("",!0),x.value<3?(t(),i(u(X),{key:1,type:"primary",disabled:!oe.value,onClick:ne},{default:n(()=>[...l[11]||(l[11]=[p(" 下一步 ",-1)])]),_:1},8,["disabled"])):d("",!0),3===x.value?(t(),i(u(X),{key:2,type:"primary",loading:Y.value,onClick:fe},{default:n(()=>[...l[12]||(l[12]=[p(" 开始导入 ",-1)])]),_:1},8,["loading"])):d("",!0),4===x.value?(t(),i(u(X),{key:3,type:"primary",onClick:we},{default:n(()=>[...l[13]||(l[13]=[p(" 完成 ",-1)])]),_:1})):d("",!0),c(u(X),{onClick:we},{default:n(()=>[...l[14]||(l[14]=[p("取消",-1)])]),_:1})]),_:1})]),default:n(()=>[c(u(M),{current:x.value,status:C.value},{default:n(()=>[c(u(E),{title:"上传文件"}),c(u(E),{title:"列映射"}),c(u(E),{title:"预览确认"}),c(u(E),{title:"导入结果"})]),_:1},8,["current","status"]),c(u(O)),1===x.value?(t(),a("div",ue,[c(u(T),{"custom-request":ie,"show-file-list":!1,accept:".xlsx,.xls,.csv"},{default:n(()=>[c(u(I),null,{default:n(()=>[s("div",ce,[c(u(B),{size:"48",depth:3},{default:n(()=>[c(u(re))]),_:1})]),c(u(F),{style:{"font-size":"16px"}},{default:n(()=>[...l[1]||(l[1]=[p(" 点击或拖拽文件到此区域上传 ",-1)])]),_:1}),c(u(P),{depth:"3",style:{margin:"8px 0 0 0"}},{default:n(()=>[...l[2]||(l[2]=[p(" 支持 .xlsx, .xls, .csv 格式，单个文件不超过 10MB ",-1)])]),_:1})]),_:1})]),_:1}),c(u(O)),c(u(V),{type:"info",title:"导入说明"},{default:n(()=>[s("ul",null,[l[5]||(l[5]=s("li",null,"支持 Excel (.xlsx, .xls) 和 CSV 格式",-1)),l[6]||(l[6]=s("li",null,"第一行应为列标题",-1)),l[7]||(l[7]=s("li",null,"必填字段：公司名称、联系人、国家、产品、询盘日期",-1)),s("li",null,[l[3]||(l[3]=p("下载 ",-1)),s("a",{href:"#",onClick:v(me,["prevent"])},"导入模板"),l[4]||(l[4]=p(" 查看格式",-1))])])]),_:1})])):d("",!0),2===x.value?(t(),a("div",de,[c(u(V),{type:"info",title:"列映射",style:{"margin-bottom":"16px"}},{default:n(()=>[...l[8]||(l[8]=[p(" 请将 Excel 列名映射到系统字段 ",-1)])]),_:1}),c(u(D),{"label-placement":"left","label-width":"120px"},{default:n(()=>[(t(),a(y,null,f(te,e=>c(u($),{key:e.key,label:e.label,required:e.required},{default:n(()=>[c(u(L),{value:ee.value[e.key],"onUpdate:value":l=>ee.value[e.key]=l,options:G.value,placeholder:"选择对应的 Excel 列",clearable:""},null,8,["value","onUpdate:value","options"])]),_:2},1032,["label","required"])),64))]),_:1})])):d("",!0),3===x.value?(t(),a("div",pe,[c(u(V),{type:"warning",title:"数据预览",style:{"margin-bottom":"16px"}},{default:n(()=>[p(" 共 "+m(le.value.length)+" 条数据，请确认无误后导入 ",1)]),_:1}),c(u(R),{columns:se.value,data:le.value.slice(0,10),"max-height":400,pagination:!1},null,8,["columns","data"]),le.value.length>10?(t(),i(u(P),{key:0,depth:"3",style:{"margin-top":"8px"}},{default:n(()=>[...l[9]||(l[9]=[p(" 仅显示前 10 条数据预览 ",-1)])]),_:1})):d("",!0)])):d("",!0),4===x.value?(t(),a("div",ve,[c(u(Q),{status:0===ae.value.failed?"success":"warning",title:0===ae.value.failed?"导入完成":"导入完成（部分失败）"},{footer:n(()=>[c(u(N),{vertical:""},{default:n(()=>[c(u(W),{label:"成功",value:ae.value.success},null,8,["value"]),c(u(W),{label:"失败",value:ae.value.failed},null,8,["value"]),ae.value.errors.length>0?(t(),i(u(A),{key:0},{default:n(()=>[c(u(H),{title:"查看错误详情",name:"errors"},{default:n(()=>[c(u(J),null,{default:n(()=>[(t(!0),a(y,null,f(ae.value.errors,e=>(t(),i(u(K),{key:e.index},{default:n(()=>[p(" 第 "+m(e.index+1)+" 行: "+m(e.error),1)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})):d("",!0)]),_:1})]),_:1},8,["status","title"])])):d("",!0)]),_:1},8,["show"]))}}),[["__scopeId","data-v-e1494b21"]]),fe={class:"customers-view"},me=te(l({__name:"Customers",setup(l){const s=k(),i=Y(),d=U(),v=b(),y=r(!1),f=r(!1),m=r(null),j=w({keyword:"",status:void 0,source:void 0,country:"",is_entered:void 0}),q=[{label:"样品已成交",value:"sample_won"},{label:"洽谈中",value:"negotiating"},{label:"排产中",value:"in_production"},{label:"已完成",value:"completed"},{label:"新一轮洽谈",value:"new_round"},{label:"已被他人成交",value:"won_by_others"},{label:"潜在客户",value:"potential"},{label:"高价值客户",value:"high_value"},{label:"无回复",value:"no_response"},{label:"不可执行",value:"not_executable"},{label:"低优先级",value:"low_priority"}],S=[{label:"网站",value:"website"},{label:"邮件",value:"email"},{label:"展会",value:"exhibition"},{label:"转介绍",value:"referral"},{label:"电话营销",value:"cold_call"},{label:"社交媒体",value:"social_media"},{label:"其他",value:"other"}],z=[{label:"已录入",value:!0},{label:"未录入",value:!1}],E=[{title:"单号",key:"code",width:150,fixed:"left",render:e=>_("a",{onClick:()=>T(e)},e.code)},{title:"公司",key:"company",width:200,ellipsis:{tooltip:!0}},{title:"联系人",key:"contact",width:120},{title:"国家",key:"country",width:100},{title:"产品",key:"product",width:150,ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:120,render:e=>{const{type:l,label:a}={sample_won:{type:"success",label:"样品已成交"},negotiating:{type:"info",label:"洽谈中"},in_production:{type:"warning",label:"排产中"},completed:{type:"success",label:"已完成"},new_round:{type:"info",label:"新一轮洽谈"},won_by_others:{type:"error",label:"已被他人成交"},potential:{type:"default",label:"潜在客户"},high_value:{type:"success",label:"高价值客户"},no_response:{type:"warning",label:"无回复"},not_executable:{type:"error",label:"不可执行"},low_priority:{type:"default",label:"低优先级"}}[e.status]||{type:"default",label:e.status};return _(ee,{type:l,size:"small"},{default:()=>a})}},{title:"是否录入",key:"is_entered",width:100,render:e=>_(le,{value:e.is_entered,disabled:!0})},{title:"询盘日期",key:"inquiry_date",width:120,render:e=>x(e.inquiry_date)},{title:"负责人",key:"owner",width:120,render:e=>e.owner?.name||e.owner?.email||"-"},{title:"操作",key:"actions",width:80,fixed:"right",render:e=>_(ae,{options:[{label:"查看",key:"view"},{label:"编辑",key:"edit"},{label:"删除",key:"delete"}],onSelect:l=>function(e,l){switch(e){case"view":T(l);break;case"edit":m.value=l,y.value=!0;break;case"delete":!function(e){i.warning({title:"确认删除",content:`确定要删除客户 "${e.company}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await v.deleteCustomer(e.id),d.success("删除成功"),F()}catch(l){d.error(l?.message||"删除失败")}}})}(l)}}(l,e)},{default:()=>_(X,{text:!0},{icon:()=>_(B,null,{default:()=>_(ne)})})})}],M=o(()=>({page:v.pagination.page,pageSize:v.pagination.pageSize,pageCount:Math.ceil(v.pagination.total/v.pagination.pageSize),showSizePicker:!0,pageSizes:[10,20,50,100],onChange:e=>P(e),onUpdatePageSize:e=>function(e){v.pagination.pageSize=e,F(1)}(e)})),O=g(()=>{F()},500);function I(){F()}async function F(e){try{await v.fetchCustomers(j,e||v.pagination.page,v.pagination.pageSize)}catch(l){d.error(l?.message||"加载客户列表失败")}}function P(e){F(e)}function T(e){s.push({name:"CustomerDetail",params:{id:e.id}})}function V(){y.value=!1,m.value=null,F()}async function $(){try{const{utils:l,writeFile:a}=await e(async()=>{const{utils:e,writeFile:l}=await import("./excel-C3s_O8KD.js");return{utils:e,writeFile:l}},[]),t=v.customers.map(e=>({"单号":e.code,"公司":e.company,"联系人":e.contact,"国家":e.country,"产品":e.product,"邮箱":e.email,"电话":e.phone,"状态":e.status,"来源":e.source,"询盘日期":e.inquiry_date,"是否录入":e.is_entered?"是":"否","备注":e.remark})),s=l.json_to_sheet(t),o=l.book_new();l.book_append_sheet(o,s,"客户列表");a(o,`customers_${(new Date).toISOString().split("T")[0]}.xlsx`),d.success("导出成功")}catch(l){d.error("导出失败："+l.message)}}return h(()=>{F()}),(e,l)=>(t(),a("div",fe,[c(u(Z),{title:"客户管理"},{"header-extra":n(()=>[c(u(N),null,{default:n(()=>[c(u(X),{type:"primary",onClick:l[0]||(l[0]=e=>y.value=!0)},{default:n(()=>[...l[9]||(l[9]=[p("新增客户",-1)])]),_:1}),c(u(X),{onClick:l[1]||(l[1]=e=>f.value=!0)},{default:n(()=>[...l[10]||(l[10]=[p("导入",-1)])]),_:1}),c(u(X),{onClick:$},{default:n(()=>[...l[11]||(l[11]=[p("导出",-1)])]),_:1})]),_:1})]),default:n(()=>[c(u(N),{vertical:"",size:"large"},{default:n(()=>[c(u(N),null,{default:n(()=>[c(u(G),{value:j.keyword,"onUpdate:value":[l[2]||(l[2]=e=>j.keyword=e),u(O)],placeholder:"搜索公司/联系人/邮箱/电话/单号",clearable:"",style:{width:"300px"}},{prefix:n(()=>[c(u(B),{component:u(se)},null,8,["component"])]),_:1},8,["value","onUpdate:value"]),c(u(L),{value:j.status,"onUpdate:value":[l[3]||(l[3]=e=>j.status=e),I],placeholder:"状态",clearable:"",style:{width:"150px"},options:q},null,8,["value"]),c(u(L),{value:j.source,"onUpdate:value":[l[4]||(l[4]=e=>j.source=e),I],placeholder:"来源",clearable:"",style:{width:"150px"},options:S},null,8,["value"]),c(u(G),{value:j.country,"onUpdate:value":[l[5]||(l[5]=e=>j.country=e),u(O)],placeholder:"国家",clearable:"",style:{width:"150px"}},null,8,["value","onUpdate:value"]),c(u(L),{value:j.is_entered,"onUpdate:value":[l[6]||(l[6]=e=>j.is_entered=e),I],placeholder:"是否录入",clearable:"",style:{width:"150px"},options:z},null,8,["value"])]),_:1}),c(u(R),{columns:E,data:u(v).customers,loading:u(v).loading,pagination:M.value,"row-key":e=>e.id,"onUpdate:page":P},null,8,["data","loading","pagination","row-key"])]),_:1})]),_:1}),c(C,{show:y.value,"onUpdate:show":l[7]||(l[7]=e=>y.value=e),customer:m.value,onSuccess:V},null,8,["show","customer"]),c(ye,{show:f.value,"onUpdate:show":l[8]||(l[8]=e=>f.value=e),onSuccess:F},null,8,["show"])]))}}),[["__scopeId","data-v-62df579c"]]);export{me as default};
