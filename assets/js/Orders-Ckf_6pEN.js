import{k as M,a0 as q,Y as U,a3 as y,a6 as K,S as X,r as w,c as B,w as ee,W as te,Z as l,N as t,_ as a,j as F,a5 as re,m as O,o as ae}from"./vue-vendor-ChRmxV0E.js";import{s as $,T}from"./index-LEjS_y3d.js";import{u as Y}from"./customer-DlWSUBeS.js";import{h,f as le,i as oe,d as ne}from"./helpers-CM6_8sGB.js";import{u as Q,H as ie,h as N,Q as A,i as L,a3 as ue,a2 as Z,g as se,B as j,y as V,W as de,z as ce,j as _,q as pe,d as fe,C as me,D as E,S as I,R as ve}from"./naive-ui-C-WnQlxP.js";import{S as ge}from"./SearchOutline-DUsqMxOm.js";import{D as he,A as we}from"./DocumentTextOutline-DEN2-gad.js";import{T as ke,C as _e}from"./TimeOutline-CuTywy_j.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./supabase-BxUUOEWR.js";const xe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},be=M({name:"CheckmarkCircleOutline",render:function(p,o){return U(),q("svg",xe,o[0]||(o[0]=[y("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),y("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M352 176L217.6 336L160 272"},null,-1)]))}}),Se={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Oe=M({name:"CreateOutline",render:function(p,o){return U(),q("svg",Se,o[0]||(o[0]=[y("path",{d:"M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),y("path",{d:"M459.94 53.25a16.06 16.06 0 0 0-23.22-.56L424.35 65a8 8 0 0 0 0 11.31l11.34 11.32a8 8 0 0 0 11.34 0l12.06-12c6.1-6.09 6.67-16.01.85-22.38z",fill:"currentColor"},null,-1),y("path",{d:"M399.34 90L218.82 270.2a9 9 0 0 0-2.31 3.93L208.16 299a3.91 3.91 0 0 0 4.86 4.86l24.85-8.35a9 9 0 0 0 3.93-2.31L422 112.66a9 9 0 0 0 0-12.66l-9.95-10a9 9 0 0 0-12.71 0z",fill:"currentColor"},null,-1)]))}}),Ce={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},De=M({name:"EllipsisHorizontalOutline",render:function(p,o){return U(),q("svg",Ce,o[0]||(o[0]=[y("circle",{cx:"256",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),y("circle",{cx:"416",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),y("circle",{cx:"96",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),ze={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Re=M({name:"RefreshOutline",render:function(p,o){return U(),q("svg",ze,o[0]||(o[0]=[y("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),y("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1)]))}}),Ne={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Me=M({name:"TrashOutline",render:function(p,o){return U(),q("svg",Ne,o[0]||(o[0]=[K('<path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352" fill="currentColor"></path><path d="M192 112V72h0a23.93 23.93 0 0 1 24-24h80a23.93 23.93 0 0 1 24 24h0v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M256 176v224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M184 176l8 224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M328 176l-8 224"></path>',6)]))}}),J=X("order",()=>{const m=w([]),p=w(null),o=w(!1),d=w({page:1,pageSize:20,total:0});async function C(n){o.value=!0;try{let e=$.from(T.ORDERS).select("*, customer:customers(id, code, company, contact)",{count:"exact"});n&&(n.keyword&&(e=e.or(`order_no.ilike.%${n.keyword}%,product.ilike.%${n.keyword}%`)),n.status&&(e=e.eq("status",n.status)),n.customer_id&&(e=e.eq("customer_id",n.customer_id)),n.date_from&&(e=e.gte("create_date",n.date_from)),n.date_to&&(e=e.lte("create_date",n.date_to)));const c=(d.value.page-1)*d.value.pageSize,S=c+d.value.pageSize-1,{data:z,error:v,count:R}=await e.order("create_date",{ascending:!1}).range(c,S);if(v)throw v;m.value=z||[],d.value.total=R||0}catch(e){throw console.error("Failed to fetch orders:",e),e}finally{o.value=!1}}async function x(n){o.value=!0;try{const{data:e,error:c}=await $.from(T.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("customer_id",n).order("create_date",{ascending:!1});if(c)throw c;return e||[]}catch(e){return console.error("Failed to fetch customer orders:",e),[]}finally{o.value=!1}}async function k(n){o.value=!0;try{const{data:e,error:c}=await $.from(T.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("id",n).single();if(c)throw c;return p.value=e,e}catch(e){return console.error("Failed to fetch order:",e),null}finally{o.value=!1}}async function D(n){o.value=!0;try{const{data:e,error:c}=await $.from(T.ORDERS).insert(n).select("*, customer:customers(id, code, company, contact)").single();return c||(e&&(m.value.unshift(e),d.value.total++),null)}catch(e){return console.error("Failed to create order:",e),e}finally{o.value=!1}}async function f(n,e){o.value=!0;try{const{data:c,error:S}=await $.from(T.ORDERS).update(e).eq("id",n).select("*, customer:customers(id, code, company, contact)").single();if(S)return S;if(c){const z=m.value.findIndex(v=>v.id===n);z!==-1&&(m.value[z]=c),p.value?.id===n&&(p.value={...p.value,...c})}return null}catch(c){return console.error("Failed to update order:",c),c}finally{o.value=!1}}async function b(n){o.value=!0;try{const{error:e}=await $.from(T.ORDERS).delete().eq("id",n);return e||(m.value=m.value.filter(c=>c.id!==n),d.value.total--,p.value?.id===n&&(p.value=null),null)}catch(e){return console.error("Failed to delete order:",e),e}finally{o.value=!1}}return{orders:m,currentOrder:p,loading:o,pagination:d,fetchOrders:C,fetchOrdersByCustomer:x,fetchOrderById:k,createOrder:D,updateOrder:f,deleteOrder:b}}),Ue=M({__name:"OrderFormModal",props:{visible:{type:Boolean},order:{default:null}},emits:["update:visible","success"],setup(m,{emit:p}){const o=m,d=p,C=Q(),x=J(),k=Y(),D=w(null),f=w(!1),b=B(()=>!!o.order),n=B({get:()=>o.visible,set:u=>d("update:visible",u)}),e=w({customer_id:"",order_no:"",product:"",profit:0,status:"pending",create_date:Date.now(),remark:""}),c=B(()=>k.customers.map(u=>({label:`${u.code} - ${u.company}`,value:u.id}))),S=[{label:h("pending"),value:"pending"},{label:h("confirmed"),value:"confirmed"},{label:h("production"),value:"production"},{label:h("shipped"),value:"shipped"},{label:h("completed"),value:"completed"},{label:h("cancelled"),value:"cancelled"}],z={customer_id:[{required:!0,message:"请选择客户",trigger:"change"}],order_no:[{required:!0,message:"请输入订单号",trigger:"blur"}],product:[{required:!0,message:"请输入产品",trigger:"blur"}],status:[{required:!0,message:"请选择订单状态",trigger:"change"}],create_date:[{required:!0,type:"number",message:"请选择创建日期",trigger:"change"}]};function v(u){const i=k.customers.find(r=>r.id===u);i&&!b.value&&(e.value.product=i.product||"")}function R(){const u=new Date,i=u.getFullYear(),r=String(u.getMonth()+1).padStart(2,"0"),s=String(u.getDate()).padStart(2,"0"),g=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`ORD${i}${r}${s}${g}`}function P(){e.value={customer_id:"",order_no:R(),product:"",profit:0,status:"pending",create_date:Date.now(),remark:""}}function H(u){e.value={customer_id:u.customer_id,order_no:u.order_no,product:u.product,profit:u.profit||0,status:u.status,create_date:new Date(u.create_date).getTime(),remark:u.remark||""}}async function G(){if(D.value)try{await D.value.validate(),f.value=!0;const u={customer_id:e.value.customer_id,order_no:e.value.order_no,product:e.value.product,profit:e.value.profit,status:e.value.status,create_date:new Date(e.value.create_date).toISOString().split("T")[0],remark:e.value.remark};let i;b.value&&o.order?i=await x.updateOrder(o.order.id,u):i=await x.createOrder(u),i?C.error(i.message||"操作失败"):(C.success(b.value?"订单已更新":"订单已创建"),d("success"),n.value=!1)}catch{}finally{f.value=!1}}function W(){n.value=!1}return ee(()=>o.visible,u=>{u&&(o.order?H(o.order):P(),k.customers.length===0&&k.fetchCustomers())}),(u,i)=>(U(),te(t(ie),{show:n.value,"onUpdate:show":i[7]||(i[7]=r=>n.value=r),preset:"card",title:b.value?"编辑订单":"新增订单",style:{width:"600px"},"mask-closable":!1},{footer:l(()=>[a(t(V),{justify:"end"},{default:l(()=>[a(t(j),{onClick:W},{default:l(()=>[...i[9]||(i[9]=[F("取消",-1)])]),_:1}),a(t(j),{type:"primary",loading:f.value,onClick:G},{default:l(()=>[F(re(b.value?"保存":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:l(()=>[a(t(se),{ref_key:"formRef",ref:D,model:e.value,rules:z,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:l(()=>[a(t(N),{label:"客户",path:"customer_id"},{default:l(()=>[a(t(A),{value:e.value.customer_id,"onUpdate:value":[i[0]||(i[0]=r=>e.value.customer_id=r),v],options:c.value,placeholder:"请选择客户",filterable:"",clearable:""},null,8,["value","options"])]),_:1}),a(t(N),{label:"订单号",path:"order_no"},{default:l(()=>[a(t(L),{value:e.value.order_no,"onUpdate:value":i[1]||(i[1]=r=>e.value.order_no=r),placeholder:"自动生成或手动输入"},null,8,["value"])]),_:1}),a(t(N),{label:"产品",path:"product"},{default:l(()=>[a(t(L),{value:e.value.product,"onUpdate:value":i[2]||(i[2]=r=>e.value.product=r),placeholder:"请输入产品名称",type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["value"])]),_:1}),a(t(N),{label:"利润 (USD)",path:"profit"},{default:l(()=>[a(t(ue),{value:e.value.profit,"onUpdate:value":i[3]||(i[3]=r=>e.value.profit=r),placeholder:"请输入利润金额",min:0,precision:2,style:{width:"100%"}},{prefix:l(()=>[...i[8]||(i[8]=[F("$",-1)])]),_:1},8,["value"])]),_:1}),a(t(N),{label:"订单状态",path:"status"},{default:l(()=>[a(t(A),{value:e.value.status,"onUpdate:value":i[4]||(i[4]=r=>e.value.status=r),options:S,placeholder:"请选择订单状态"},null,8,["value"])]),_:1}),a(t(N),{label:"创建日期",path:"create_date"},{default:l(()=>[a(t(Z),{value:e.value.create_date,"onUpdate:value":i[5]||(i[5]=r=>e.value.create_date=r),type:"date",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),a(t(N),{label:"备注",path:"remark"},{default:l(()=>[a(t(L),{value:e.value.remark,"onUpdate:value":i[6]||(i[6]=r=>e.value.remark=r),placeholder:"请输入备注信息",type:"textarea",autosize:{minRows:3,maxRows:6}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]))}}),$e={class:"orders-view"},Te=M({__name:"Orders",setup(m){const p=Q(),o=de(),d=J(),C=Y(),x=w(!1),k=w(null),D=w(null),f=w({keyword:"",status:null,customer_id:null,date_from:"",date_to:""}),b=B(()=>C.customers.map(r=>({label:`${r.code} - ${r.company}`,value:r.id}))),n=[{label:h("pending"),value:"pending"},{label:h("confirmed"),value:"confirmed"},{label:h("production"),value:"production"},{label:h("shipped"),value:"shipped"},{label:h("completed"),value:"completed"},{label:h("cancelled"),value:"cancelled"}],e=B(()=>({page:d.pagination.page,pageSize:d.pagination.pageSize,pageCount:Math.ceil(d.pagination.total/d.pagination.pageSize),itemCount:d.pagination.total,showSizePicker:!0,pageSizes:[10,20,50,100],onChange:r=>{d.pagination.page=r,v()},onUpdatePageSize:r=>{d.pagination.pageSize=r,d.pagination.page=1,v()}})),c=B(()=>[{title:"订单号",key:"order_no",width:150,ellipsis:{tooltip:!0}},{title:"客户",key:"customer",width:180,ellipsis:{tooltip:!0},render:r=>r.customer?.company||"-"},{title:"产品",key:"product",ellipsis:{tooltip:!0},render:r=>r.product||"-"},{title:"利润 (USD)",key:"profit",width:120,align:"right",render:r=>r.profit?`$${r.profit.toFixed(2)}`:"-"},{title:"状态",key:"status",width:100,render:r=>O(ce,{type:oe(r.status),size:"small"},{default:()=>h(r.status)})},{title:"创建日期",key:"create_date",width:120,render:r=>le(r.create_date)},{title:"操作",key:"actions",width:80,align:"center",render:r=>O(pe,{trigger:"click",options:[{label:"编辑",key:"edit",icon:()=>O(_,null,{default:()=>O(Oe)})},{label:"删除",key:"delete",icon:()=>O(_,null,{default:()=>O(Me)})}],onSelect:s=>W(s,r)},{default:()=>O(j,{text:!0,size:"small"},{icon:()=>O(_,{size:20},{default:()=>O(De)})})})}]);function S(r){return d.orders.filter(s=>s.status===r).length}function z(){return d.orders.reduce((r,s)=>r+(s.profit||0),0)}async function v(){try{await d.fetchOrders(f.value)}catch(r){p.error("加载订单失败："+r.message)}}const R=ne(()=>{d.pagination.page=1,v()},300);function P(r){r?(f.value.date_from=new Date(r[0]).toISOString().split("T")[0],f.value.date_to=new Date(r[1]).toISOString().split("T")[0]):(f.value.date_from="",f.value.date_to=""),R()}function H(){k.value=null,x.value=!0}function G(){v()}function W(r,s){r==="edit"?(k.value=s,x.value=!0):r==="delete"&&u(s)}function u(r){o.warning({title:"确认删除",content:`确定要删除订单 "${r.order_no}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{const s=await d.deleteOrder(r.id);s?p.error("删除失败："+s.message):(p.success("订单已删除"),v())}})}function i(){v()}return ae(()=>{v(),C.customers.length===0&&C.fetchCustomers()}),(r,s)=>(U(),q("div",$e,[a(t(fe),{title:"订单管理",bordered:!1},{"header-extra":l(()=>[a(t(V),null,{default:l(()=>[a(t(j),{type:"primary",onClick:H},{icon:l(()=>[a(t(_),null,{default:l(()=>[a(t(we))]),_:1})]),default:l(()=>[s[5]||(s[5]=F(" 新增订单 ",-1))]),_:1}),a(t(j),{onClick:G},{icon:l(()=>[a(t(_),null,{default:l(()=>[a(t(Re))]),_:1})]),default:l(()=>[s[6]||(s[6]=F(" 刷新 ",-1))]),_:1})]),_:1})]),default:l(()=>[a(t(V),{vertical:"",size:"large"},{default:l(()=>[a(t(V),null,{default:l(()=>[a(t(L),{value:f.value.keyword,"onUpdate:value":[s[0]||(s[0]=g=>f.value.keyword=g),t(R)],placeholder:"搜索订单号、产品",style:{width:"250px"},clearable:""},{prefix:l(()=>[a(t(_),null,{default:l(()=>[a(t(ge))]),_:1})]),_:1},8,["value","onUpdate:value"]),a(t(A),{value:f.value.status,"onUpdate:value":[s[1]||(s[1]=g=>f.value.status=g),t(R)],placeholder:"订单状态",style:{width:"150px"},clearable:"",options:n},null,8,["value","onUpdate:value"]),a(t(A),{value:f.value.customer_id,"onUpdate:value":[s[2]||(s[2]=g=>f.value.customer_id=g),t(R)],placeholder:"客户筛选",style:{width:"200px"},clearable:"",filterable:"",options:b.value},null,8,["value","options","onUpdate:value"]),a(t(Z),{value:D.value,"onUpdate:value":[s[3]||(s[3]=g=>D.value=g),P],type:"daterange",clearable:"",placeholder:"创建日期范围"},null,8,["value"])]),_:1}),a(t(me),{cols:4,"x-gap":16},{default:l(()=>[a(t(E),null,{default:l(()=>[a(t(I),{label:"订单总数",value:t(d).pagination.total},{prefix:l(()=>[a(t(_),{size:"20",color:"#18a058"},{default:l(()=>[a(t(he))]),_:1})]),_:1},8,["value"])]),_:1}),a(t(E),null,{default:l(()=>[a(t(I),{label:"已完成",value:S("completed")},{prefix:l(()=>[a(t(_),{size:"20",color:"#2080f0"},{default:l(()=>[a(t(be))]),_:1})]),_:1},8,["value"])]),_:1}),a(t(E),null,{default:l(()=>[a(t(I),{label:"生产中",value:S("production")},{prefix:l(()=>[a(t(_),{size:"20",color:"#f0a020"},{default:l(()=>[a(t(ke))]),_:1})]),_:1},8,["value"])]),_:1}),a(t(E),null,{default:l(()=>[a(t(I),{label:"总利润 (USD)",value:z(),precision:2},{prefix:l(()=>[a(t(_),{size:"20",color:"#d03050"},{default:l(()=>[a(t(_e))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),a(t(ve),{columns:c.value,data:t(d).orders,loading:t(d).loading,pagination:e.value,"row-key":g=>g.id,bordered:!1,striped:""},null,8,["columns","data","loading","pagination","row-key"])]),_:1})]),_:1}),a(Ue,{visible:x.value,"onUpdate:visible":s[4]||(s[4]=g=>x.value=g),order:k.value,onSuccess:i},null,8,["visible","order"])]))}}),He=ye(Te,[["__scopeId","data-v-52243fd0"]]);export{He as default};
