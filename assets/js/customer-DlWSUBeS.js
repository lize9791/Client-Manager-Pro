import{S as k,r as f}from"./vue-vendor-ChRmxV0E.js";import{u as g,s as i,T as c}from"./index-LEjS_y3d.js";const x=k("customer",()=>{const s=f([]),n=f(null),a=f(!1),l=f({page:1,pageSize:20,total:0}),d=g();async function v(e,o=1,t=20){a.value=!0;try{let r=i.from(c.CUSTOMERS).select("*, owner:users!owner_id(id, email, name)",{count:"exact"});d.isSales&&d.user&&(r=r.eq("owner_id",d.user.id)),e&&(e.keyword&&(r=r.or(`company.ilike.%${e.keyword}%,contact.ilike.%${e.keyword}%,email.ilike.%${e.keyword}%,phone.ilike.%${e.keyword}%,code.ilike.%${e.keyword}%`)),e.country&&(r=r.eq("country",e.country)),e.status&&(r=r.eq("status",e.status)),e.is_entered!==void 0&&(r=r.eq("is_entered",e.is_entered)),e.owner_id&&(r=r.eq("owner_id",e.owner_id)),e.source&&(r=r.eq("source",e.source)),e.date_from&&(r=r.gte("inquiry_date",e.date_from)),e.date_to&&(r=r.lte("inquiry_date",e.date_to)));const u=(o-1)*t,m=u+t-1,{data:p,error:y,count:q}=await r.order("created_at",{ascending:!1}).range(u,m);if(y)throw y;s.value=p||[],l.value={page:o,pageSize:t,total:q||0}}catch(r){throw console.error("Failed to fetch customers:",r),r}finally{a.value=!1}}async function h(e){a.value=!0;try{const{data:o,error:t}=await i.from(c.CUSTOMERS).select(`
          *,
          owner:users!owner_id(id, email, name),
          orders(*),
          followups(*, follower:users!follower_id(id, email, name))
        `).eq("id",e).single();if(t)throw t;return n.value=o,o}catch(o){return console.error("Failed to fetch customer:",o),null}finally{a.value=!1}}async function w(e){a.value=!0;try{const o={...e,owner_id:e.owner_id||d.user?.id},{data:t,error:r}=await i.from(c.CUSTOMERS).insert(o).select("*, owner:users!owner_id(id, email, name)").single();if(r)throw r;return s.value.unshift(t),l.value.total++,t}catch(o){throw console.error("Failed to create customer:",o),o}finally{a.value=!1}}async function _(e,o){a.value=!0;try{const{data:t,error:r}=await i.from(c.CUSTOMERS).update(o).eq("id",e).select("*, owner:users!owner_id(id, email, name)").single();if(r)throw r;const u=s.value.findIndex(m=>m.id===e);return u!==-1&&(s.value[u]=t),n.value?.id===e&&(n.value={...n.value,...t}),!0}catch(t){throw console.error("Failed to update customer:",t),t}finally{a.value=!1}}async function S(e){a.value=!0;try{const{error:o}=await i.from(c.CUSTOMERS).delete().eq("id",e);if(o)throw o;return s.value=s.value.filter(t=>t.id!==e),l.value.total--,n.value?.id===e&&(n.value=null),!0}catch(o){throw console.error("Failed to delete customer:",o),o}finally{a.value=!1}}async function C(e){const o={success:0,failed:0,errors:[]};for(let t=0;t<e.length;t++)try{await w(e[t]),o.success++}catch(r){o.failed++,o.errors.push({index:t,error:r instanceof Error?r.message:"未知错误"})}return o}return{customers:s,currentCustomer:n,loading:a,pagination:l,fetchCustomers:v,fetchCustomerById:h,createCustomer:w,updateCustomer:_,deleteCustomer:S,importCustomers:C}});export{x as u};
