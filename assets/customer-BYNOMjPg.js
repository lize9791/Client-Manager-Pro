import{p as e,r,a as t,s as o,T as a}from"./index-kQabTG3v.js";const n=e("customer",()=>{const e=r([]),n=r(null),i=r(!1),l=r({page:1,pageSize:20,total:0}),s=t();async function u(r){var t;i.value=!0;try{const n={...r,owner_id:r.owner_id||(null==(t=s.user)?void 0:t.id)},{data:i,error:u}=await o.from(a.CUSTOMERS).insert(n).select("*, owner:users!owner_id(id, email, name)").single();if(u)throw u;return e.value.unshift(i),l.value.total++,i}catch(n){throw console.error("Failed to create customer:",n),n}finally{i.value=!1}}return{customers:e,currentCustomer:n,loading:i,pagination:l,fetchCustomers:async function(r,t=1,n=20){i.value=!0;try{let i=o.from(a.CUSTOMERS).select("*, owner:users!owner_id(id, email, name)",{count:"exact"});s.isSales&&s.user&&(i=i.eq("owner_id",s.user.id)),r&&(r.keyword&&(i=i.or(`company.ilike.%${r.keyword}%,contact.ilike.%${r.keyword}%,email.ilike.%${r.keyword}%,phone.ilike.%${r.keyword}%,code.ilike.%${r.keyword}%`)),r.country&&(i=i.eq("country",r.country)),r.status&&(i=i.eq("status",r.status)),void 0!==r.is_entered&&(i=i.eq("is_entered",r.is_entered)),r.owner_id&&(i=i.eq("owner_id",r.owner_id)),r.source&&(i=i.eq("source",r.source)),r.date_from&&(i=i.gte("inquiry_date",r.date_from)),r.date_to&&(i=i.lte("inquiry_date",r.date_to)));const u=(t-1)*n,c=u+n-1,{data:d,error:f,count:w}=await i.order("created_at",{ascending:!1}).range(u,c);if(f)throw f;e.value=d||[],l.value={page:t,pageSize:n,total:w||0}}catch(u){throw console.error("Failed to fetch customers:",u),u}finally{i.value=!1}},fetchCustomerById:async function(e){i.value=!0;try{const{data:r,error:t}=await o.from(a.CUSTOMERS).select("\n          *,\n          owner:users!owner_id(id, email, name),\n          orders(*),\n          followups(*, follower:users!follower_id(id, email, name))\n        ").eq("id",e).single();if(t)throw t;return n.value=r,r}catch(r){return console.error("Failed to fetch customer:",r),null}finally{i.value=!1}},createCustomer:u,updateCustomer:async function(r,t){var l;i.value=!0;try{const{data:i,error:s}=await o.from(a.CUSTOMERS).update(t).eq("id",r).select("*, owner:users!owner_id(id, email, name)").single();if(s)throw s;const u=e.value.findIndex(e=>e.id===r);return-1!==u&&(e.value[u]=i),(null==(l=n.value)?void 0:l.id)===r&&(n.value={...n.value,...i}),!0}catch(s){throw console.error("Failed to update customer:",s),s}finally{i.value=!1}},deleteCustomer:async function(r){var t;i.value=!0;try{const{error:i}=await o.from(a.CUSTOMERS).delete().eq("id",r);if(i)throw i;return e.value=e.value.filter(e=>e.id!==r),l.value.total--,(null==(t=n.value)?void 0:t.id)===r&&(n.value=null),!0}catch(s){throw console.error("Failed to delete customer:",s),s}finally{i.value=!1}},importCustomers:async function(e){const r={success:0,failed:0,errors:[]};for(let o=0;o<e.length;o++)try{await u(e[o]),r.success++}catch(t){r.failed++,r.errors.push({index:o,error:t instanceof Error?t.message:"未知错误"})}return r}}});export{n as u};
