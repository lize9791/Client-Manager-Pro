{"version":3,"file":"customer-BPUWG0Bc.js","sources":["../../src/stores/customer.ts"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref } from 'vue'\nimport { supabase, TABLES } from '@/utils/supabase'\nimport type { Customer, CustomerFilter, Pagination, PaginatedResponse } from '@/types'\nimport { useAuthStore } from './auth'\n\nexport const useCustomerStore = defineStore('customer', () => {\n  const customers = ref<Customer[]>([])\n  const currentCustomer = ref<Customer | null>(null)\n  const loading = ref(false)\n  const pagination = ref<Pagination>({\n    page: 1,\n    pageSize: 20,\n    total: 0\n  })\n\n  const authStore = useAuthStore()\n\n  /**\n   * 获取客户列表\n   */\n  async function fetchCustomers(\n    filter?: CustomerFilter,\n    page: number = 1,\n    pageSize: number = 20\n  ): Promise<void> {\n    loading.value = true\n    try {\n      let query = supabase\n        .from(TABLES.CUSTOMERS)\n        .select('*, owner:users!owner_id(id, email, name)', { count: 'exact' })\n\n      // 权限过滤：Sales 只能看自己的数据\n      if (authStore.isSales && authStore.user) {\n        query = query.eq('owner_id', authStore.user.id)\n      }\n\n      // 应用筛选条件\n      if (filter) {\n        if (filter.keyword) {\n          query = query.or(\n            `company.ilike.%${filter.keyword}%,contact.ilike.%${filter.keyword}%,email.ilike.%${filter.keyword}%,phone.ilike.%${filter.keyword}%,code.ilike.%${filter.keyword}%`\n          )\n        }\n        if (filter.country) query = query.eq('country', filter.country)\n        if (filter.status) query = query.eq('status', filter.status)\n        if (filter.is_entered !== undefined) query = query.eq('is_entered', filter.is_entered)\n        if (filter.owner_id) query = query.eq('owner_id', filter.owner_id)\n        if (filter.source) query = query.eq('source', filter.source)\n        if (filter.date_from) query = query.gte('inquiry_date', filter.date_from)\n        if (filter.date_to) query = query.lte('inquiry_date', filter.date_to)\n      }\n\n      // 分页\n      const from = (page - 1) * pageSize\n      const to = from + pageSize - 1\n\n      const { data, error, count } = await query\n        .order('created_at', { ascending: false })\n        .range(from, to)\n\n      if (error) throw error\n\n      customers.value = data || []\n      pagination.value = {\n        page,\n        pageSize,\n        total: count || 0\n      }\n    } catch (error) {\n      console.error('Failed to fetch customers:', error)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 获取单个客户详情（包含订单和跟进记录）\n   */\n  async function fetchCustomerById(id: string): Promise<Customer | null> {\n    loading.value = true\n    try {\n      const { data, error } = await supabase\n        .from(TABLES.CUSTOMERS)\n        .select(\n          `\n          *,\n          owner:users!owner_id(id, email, name),\n          orders(*),\n          followups(*, follower:users!follower_id(id, email, name))\n        `\n        )\n        .eq('id', id)\n        .single()\n\n      if (error) throw error\n\n      currentCustomer.value = data\n      return data\n    } catch (error) {\n      console.error('Failed to fetch customer:', error)\n      return null\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 创建客户\n   */\n  async function createCustomer(customer: Partial<Customer>): Promise<Customer | null> {\n    loading.value = true\n    try {\n      // 自动设置 owner_id 为当前用户\n      const newCustomer = {\n        ...customer,\n        owner_id: customer.owner_id || authStore.user?.id\n      }\n\n      const { data, error } = await supabase\n        .from(TABLES.CUSTOMERS)\n        .insert(newCustomer)\n        .select('*, owner:users!owner_id(id, email, name)')\n        .single()\n\n      if (error) throw error\n\n      // 添加到列表\n      customers.value.unshift(data)\n      pagination.value.total++\n\n      return data\n    } catch (error) {\n      console.error('Failed to create customer:', error)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 更新客户\n   */\n  async function updateCustomer(id: string, updates: Partial<Customer>): Promise<boolean> {\n    loading.value = true\n    try {\n      const { data, error } = await supabase\n        .from(TABLES.CUSTOMERS)\n        .update(updates)\n        .eq('id', id)\n        .select('*, owner:users!owner_id(id, email, name)')\n        .single()\n\n      if (error) throw error\n\n      // 更新列表中的数据\n      const index = customers.value.findIndex(c => c.id === id)\n      if (index !== -1) {\n        customers.value[index] = data\n      }\n\n      // 更新当前客户\n      if (currentCustomer.value?.id === id) {\n        currentCustomer.value = { ...currentCustomer.value, ...data }\n      }\n\n      return true\n    } catch (error) {\n      console.error('Failed to update customer:', error)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 删除客户\n   */\n  async function deleteCustomer(id: string): Promise<boolean> {\n    loading.value = true\n    try {\n      const { error } = await supabase.from(TABLES.CUSTOMERS).delete().eq('id', id)\n\n      if (error) throw error\n\n      // 从列表中移除\n      customers.value = customers.value.filter(c => c.id !== id)\n      pagination.value.total--\n\n      if (currentCustomer.value?.id === id) {\n        currentCustomer.value = null\n      }\n\n      return true\n    } catch (error) {\n      console.error('Failed to delete customer:', error)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  /**\n   * 批量导入客户\n   */\n  async function importCustomers(customers: Partial<Customer>[]): Promise<{\n    success: number\n    failed: number\n    errors: Array<{ index: number; error: string }>\n  }> {\n    const results = {\n      success: 0,\n      failed: 0,\n      errors: [] as Array<{ index: number; error: string }>\n    }\n\n    for (let i = 0; i < customers.length; i++) {\n      try {\n        await createCustomer(customers[i])\n        results.success++\n      } catch (error) {\n        results.failed++\n        results.errors.push({\n          index: i,\n          error: error instanceof Error ? error.message : '未知错误'\n        })\n      }\n    }\n\n    return results\n  }\n\n  return {\n    customers,\n    currentCustomer,\n    loading,\n    pagination,\n    fetchCustomers,\n    fetchCustomerById,\n    createCustomer,\n    updateCustomer,\n    deleteCustomer,\n    importCustomers\n  }\n})\n"],"names":["useCustomerStore","defineStore","customers","ref","currentCustomer","loading","pagination","authStore","useAuthStore","fetchCustomers","filter","page","pageSize","query","supabase","TABLES","from","to","data","error","count","fetchCustomerById","id","createCustomer","customer","newCustomer","updateCustomer","updates","index","c","deleteCustomer","importCustomers","results","i"],"mappings":"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"}