import{d as e,c as t,o as a,n as l,W as r,p as o,r as n,s as u,T as i,u as s,q as d,ar as c,z as p,w as v,e as f,a2 as m,b as h,j as g,ac as w,k,au as _,m as y,at as x,i as b,B as S,H as C,R as O,ai as z,v as D,S as R,x as U,G as M,y as j,N as $,Y as q,Z as T,ae as B,ad as F}from"./index-kQabTG3v.js";import{u as E}from"./customer-BYNOMjPg.js";import{h as I,f as L,i as H,d as P}from"./helpers-Ba1kvV6f.js";import{S as V}from"./SearchOutline-BsAp0IQr.js";import{D as Y,A}from"./DocumentTextOutline-GppExdnX.js";import{T as G,C as N}from"./TimeOutline-CWA-QL2k.js";import{_ as W}from"./_plugin-vue_export-helper-BCo6x5W8.js";const Z={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},J=e({name:"CheckmarkCircleOutline",render:function(e,r){return a(),t("svg",Z,r[0]||(r[0]=[l("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M352 176L217.6 336L160 272"},null,-1)]))}}),K={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Q=e({name:"CreateOutline",render:function(e,r){return a(),t("svg",K,r[0]||(r[0]=[l("path",{d:"M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),l("path",{d:"M459.94 53.25a16.06 16.06 0 0 0-23.22-.56L424.35 65a8 8 0 0 0 0 11.31l11.34 11.32a8 8 0 0 0 11.34 0l12.06-12c6.1-6.09 6.67-16.01.85-22.38z",fill:"currentColor"},null,-1),l("path",{d:"M399.34 90L218.82 270.2a9 9 0 0 0-2.31 3.93L208.16 299a3.91 3.91 0 0 0 4.86 4.86l24.85-8.35a9 9 0 0 0 3.93-2.31L422 112.66a9 9 0 0 0 0-12.66l-9.95-10a9 9 0 0 0-12.71 0z",fill:"currentColor"},null,-1)]))}}),X={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ee=e({name:"EllipsisHorizontalOutline",render:function(e,r){return a(),t("svg",X,r[0]||(r[0]=[l("circle",{cx:"256",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("circle",{cx:"416",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("circle",{cx:"96",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),te={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ae=e({name:"RefreshOutline",render:function(e,r){return a(),t("svg",te,r[0]||(r[0]=[l("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1)]))}}),le={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},re=e({name:"TrashOutline",render:function(e,l){return a(),t("svg",le,l[0]||(l[0]=[r('<path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352" fill="currentColor"></path><path d="M192 112V72h0a23.93 23.93 0 0 1 24-24h80a23.93 23.93 0 0 1 24 24h0v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M256 176v224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M184 176l8 224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M328 176l-8 224"></path>',6)]))}}),oe=o("order",()=>{const e=n([]),t=n(null),a=n(!1),l=n({page:1,pageSize:20,total:0});return{orders:e,currentOrder:t,loading:a,pagination:l,fetchOrders:async function(t){a.value=!0;try{let a=u.from(i.ORDERS).select("*, customer:customers(id, code, company, contact)",{count:"exact"});t&&(t.keyword&&(a=a.or(`order_no.ilike.%${t.keyword}%,product.ilike.%${t.keyword}%`)),t.status&&(a=a.eq("status",t.status)),t.customer_id&&(a=a.eq("customer_id",t.customer_id)),t.date_from&&(a=a.gte("create_date",t.date_from)),t.date_to&&(a=a.lte("create_date",t.date_to)));const r=(l.value.page-1)*l.value.pageSize,o=r+l.value.pageSize-1,{data:n,error:s,count:d}=await a.order("create_date",{ascending:!1}).range(r,o);if(s)throw s;e.value=n||[],l.value.total=d||0}catch(r){throw console.error("Failed to fetch orders:",r),r}finally{a.value=!1}},fetchOrdersByCustomer:async function(e){a.value=!0;try{const{data:t,error:a}=await u.from(i.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("customer_id",e).order("create_date",{ascending:!1});if(a)throw a;return t||[]}catch(t){return console.error("Failed to fetch customer orders:",t),[]}finally{a.value=!1}},fetchOrderById:async function(e){a.value=!0;try{const{data:a,error:l}=await u.from(i.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("id",e).single();if(l)throw l;return t.value=a,a}catch(l){return console.error("Failed to fetch order:",l),null}finally{a.value=!1}},createOrder:async function(t){a.value=!0;try{const{data:a,error:r}=await u.from(i.ORDERS).insert(t).select("*, customer:customers(id, code, company, contact)").single();return r||(a&&(e.value.unshift(a),l.value.total++),null)}catch(r){return console.error("Failed to create order:",r),r}finally{a.value=!1}},updateOrder:async function(l,r){var o;a.value=!0;try{const{data:a,error:n}=await u.from(i.ORDERS).update(r).eq("id",l).select("*, customer:customers(id, code, company, contact)").single();if(n)return n;if(a){const r=e.value.findIndex(e=>e.id===l);-1!==r&&(e.value[r]=a),(null==(o=t.value)?void 0:o.id)===l&&(t.value={...t.value,...a})}return null}catch(n){return console.error("Failed to update order:",n),n}finally{a.value=!1}},deleteOrder:async function(r){var o;a.value=!0;try{const{error:a}=await u.from(i.ORDERS).delete().eq("id",r);return a||(e.value=e.value.filter(e=>e.id!==r),l.value.total--,(null==(o=t.value)?void 0:o.id)===r&&(t.value=null),null)}catch(n){return console.error("Failed to delete order:",n),n}finally{a.value=!1}}}}),ne=e({__name:"OrderFormModal",props:{visible:{type:Boolean},order:{default:null}},emits:["update:visible","success"],setup(e,{emit:t}){const l=e,r=t,o=s(),u=oe(),i=E(),z=n(null),D=n(!1),R=d(()=>!!l.order),U=d({get:()=>l.visible,set:e=>r("update:visible",e)}),M=n({customer_id:"",order_no:"",product:"",profit:0,status:"pending",create_date:Date.now(),remark:""}),j=d(()=>i.customers.map(e=>({label:`${e.code} - ${e.company}`,value:e.id}))),$=[{label:I("pending"),value:"pending"},{label:I("confirmed"),value:"confirmed"},{label:I("production"),value:"production"},{label:I("shipped"),value:"shipped"},{label:I("completed"),value:"completed"},{label:I("cancelled"),value:"cancelled"}],q={customer_id:[{required:!0,message:"请选择客户",trigger:"change"}],order_no:[{required:!0,message:"请输入订单号",trigger:"blur"}],product:[{required:!0,message:"请输入产品",trigger:"blur"}],status:[{required:!0,message:"请选择订单状态",trigger:"change"}],create_date:[{required:!0,type:"number",message:"请选择创建日期",trigger:"change"}]};function T(e){const t=i.customers.find(t=>t.id===e);t&&!R.value&&(M.value.product=t.product||"")}function B(){const e=new Date;return`ORD${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${Math.floor(1e3*Math.random()).toString().padStart(3,"0")}`}async function F(){if(z.value)try{await z.value.validate(),D.value=!0;const e={customer_id:M.value.customer_id,order_no:M.value.order_no,product:M.value.product,profit:M.value.profit,status:M.value.status,create_date:new Date(M.value.create_date).toISOString().split("T")[0],remark:M.value.remark};let t;t=R.value&&l.order?await u.updateOrder(l.order.id,e):await u.createOrder(e),t?o.error(t.message||"操作失败"):(o.success(R.value?"订单已更新":"订单已创建"),r("success"),U.value=!1)}catch(e){}finally{D.value=!1}}function L(){U.value=!1}return c(()=>l.visible,e=>{var t;e&&(l.order?(t=l.order,M.value={customer_id:t.customer_id,order_no:t.order_no,product:t.product,profit:t.profit||0,status:t.status,create_date:new Date(t.create_date).getTime(),remark:t.remark||""}):M.value={customer_id:"",order_no:B(),product:"",profit:0,status:"pending",create_date:Date.now(),remark:""},0===i.customers.length&&i.fetchCustomers())}),(e,t)=>(a(),p(f(m),{show:U.value,"onUpdate:show":t[7]||(t[7]=e=>U.value=e),preset:"card",title:R.value?"编辑订单":"新增订单",style:{width:"600px"},"mask-closable":!1},{footer:v(()=>[h(f(O),{justify:"end"},{default:v(()=>[h(f(S),{onClick:L},{default:v(()=>[...t[9]||(t[9]=[y("取消",-1)])]),_:1}),h(f(S),{type:"primary",loading:D.value,onClick:F},{default:v(()=>[y(C(R.value?"保存":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:v(()=>[h(f(b),{ref_key:"formRef",ref:z,model:M.value,rules:q,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:v(()=>[h(f(g),{label:"客户",path:"customer_id"},{default:v(()=>[h(f(w),{value:M.value.customer_id,"onUpdate:value":[t[0]||(t[0]=e=>M.value.customer_id=e),T],options:j.value,placeholder:"请选择客户",filterable:"",clearable:""},null,8,["value","options"])]),_:1}),h(f(g),{label:"订单号",path:"order_no"},{default:v(()=>[h(f(k),{value:M.value.order_no,"onUpdate:value":t[1]||(t[1]=e=>M.value.order_no=e),placeholder:"自动生成或手动输入"},null,8,["value"])]),_:1}),h(f(g),{label:"产品",path:"product"},{default:v(()=>[h(f(k),{value:M.value.product,"onUpdate:value":t[2]||(t[2]=e=>M.value.product=e),placeholder:"请输入产品名称",type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["value"])]),_:1}),h(f(g),{label:"利润 (USD)",path:"profit"},{default:v(()=>[h(f(_),{value:M.value.profit,"onUpdate:value":t[3]||(t[3]=e=>M.value.profit=e),placeholder:"请输入利润金额",min:0,precision:2,style:{width:"100%"}},{prefix:v(()=>[...t[8]||(t[8]=[y("$",-1)])]),_:1},8,["value"])]),_:1}),h(f(g),{label:"订单状态",path:"status"},{default:v(()=>[h(f(w),{value:M.value.status,"onUpdate:value":t[4]||(t[4]=e=>M.value.status=e),options:$,placeholder:"请选择订单状态"},null,8,["value"])]),_:1}),h(f(g),{label:"创建日期",path:"create_date"},{default:v(()=>[h(f(x),{value:M.value.create_date,"onUpdate:value":t[5]||(t[5]=e=>M.value.create_date=e),type:"date",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),h(f(g),{label:"备注",path:"remark"},{default:v(()=>[h(f(k),{value:M.value.remark,"onUpdate:value":t[6]||(t[6]=e=>M.value.remark=e),placeholder:"请输入备注信息",type:"textarea",autosize:{minRows:3,maxRows:6}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]))}}),ue={class:"orders-view"},ie=W(e({__name:"Orders",setup(e){const l=s(),r=z(),o=oe(),u=E(),i=n(!1),c=n(null),p=n(null),m=n({keyword:"",status:null,customer_id:null,date_from:"",date_to:""}),g=d(()=>u.customers.map(e=>({label:`${e.code} - ${e.company}`,value:e.id}))),_=[{label:I("pending"),value:"pending"},{label:I("confirmed"),value:"confirmed"},{label:I("production"),value:"production"},{label:I("shipped"),value:"shipped"},{label:I("completed"),value:"completed"},{label:I("cancelled"),value:"cancelled"}],b=d(()=>({page:o.pagination.page,pageSize:o.pagination.pageSize,pageCount:Math.ceil(o.pagination.total/o.pagination.pageSize),itemCount:o.pagination.total,showSizePicker:!0,pageSizes:[10,20,50,100],onChange:e=>{o.pagination.page=e,Z()},onUpdatePageSize:e=>{o.pagination.pageSize=e,o.pagination.page=1,Z()}})),C=d(()=>[{title:"订单号",key:"order_no",width:150,ellipsis:{tooltip:!0}},{title:"客户",key:"customer",width:180,ellipsis:{tooltip:!0},render:e=>{var t;return(null==(t=e.customer)?void 0:t.company)||"-"}},{title:"产品",key:"product",ellipsis:{tooltip:!0},render:e=>e.product||"-"},{title:"利润 (USD)",key:"profit",width:120,align:"right",render:e=>e.profit?`$${e.profit.toFixed(2)}`:"-"},{title:"状态",key:"status",width:100,render:e=>D(R,{type:H(e.status),size:"small"},{default:()=>I(e.status)})},{title:"创建日期",key:"create_date",width:120,render:e=>L(e.create_date)},{title:"操作",key:"actions",width:80,align:"center",render:e=>D(M,{trigger:"click",options:[{label:"编辑",key:"edit",icon:()=>D(U,null,{default:()=>D(Q)})},{label:"删除",key:"delete",icon:()=>D(U,null,{default:()=>D(re)})}],onSelect:t=>{return n=e,void("edit"===(a=t)?(c.value=n,i.value=!0):"delete"===a&&function(e){r.warning({title:"确认删除",content:`确定要删除订单 "${e.order_no}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{const t=await o.deleteOrder(e.id);t?l.error("删除失败："+t.message):(l.success("订单已删除"),Z())}})}(n));var a,n}},{default:()=>D(S,{text:!0,size:"small"},{icon:()=>D(U,{size:20},{default:()=>D(ee)})})})}]);function W(e){return o.orders.filter(t=>t.status===e).length}async function Z(){try{await o.fetchOrders(m.value)}catch(e){l.error("加载订单失败："+e.message)}}const K=P(()=>{o.pagination.page=1,Z()},300);function X(e){e?(m.value.date_from=new Date(e[0]).toISOString().split("T")[0],m.value.date_to=new Date(e[1]).toISOString().split("T")[0]):(m.value.date_from="",m.value.date_to=""),K()}function te(){c.value=null,i.value=!0}function le(){Z()}function ie(){Z()}return j(()=>{Z(),0===u.customers.length&&u.fetchCustomers()}),(e,l)=>(a(),t("div",ue,[h(f($),{title:"订单管理",bordered:!1},{"header-extra":v(()=>[h(f(O),null,{default:v(()=>[h(f(S),{type:"primary",onClick:te},{icon:v(()=>[h(f(U),null,{default:v(()=>[h(f(A))]),_:1})]),default:v(()=>[l[5]||(l[5]=y(" 新增订单 ",-1))]),_:1}),h(f(S),{onClick:le},{icon:v(()=>[h(f(U),null,{default:v(()=>[h(f(ae))]),_:1})]),default:v(()=>[l[6]||(l[6]=y(" 刷新 ",-1))]),_:1})]),_:1})]),default:v(()=>[h(f(O),{vertical:"",size:"large"},{default:v(()=>[h(f(O),null,{default:v(()=>[h(f(k),{value:m.value.keyword,"onUpdate:value":[l[0]||(l[0]=e=>m.value.keyword=e),f(K)],placeholder:"搜索订单号、产品",style:{width:"250px"},clearable:""},{prefix:v(()=>[h(f(U),null,{default:v(()=>[h(f(V))]),_:1})]),_:1},8,["value","onUpdate:value"]),h(f(w),{value:m.value.status,"onUpdate:value":[l[1]||(l[1]=e=>m.value.status=e),f(K)],placeholder:"订单状态",style:{width:"150px"},clearable:"",options:_},null,8,["value","onUpdate:value"]),h(f(w),{value:m.value.customer_id,"onUpdate:value":[l[2]||(l[2]=e=>m.value.customer_id=e),f(K)],placeholder:"客户筛选",style:{width:"200px"},clearable:"",filterable:"",options:g.value},null,8,["value","options","onUpdate:value"]),h(f(x),{value:p.value,"onUpdate:value":[l[3]||(l[3]=e=>p.value=e),X],type:"daterange",clearable:"",placeholder:"创建日期范围"},null,8,["value"])]),_:1}),h(f(q),{cols:4,"x-gap":16},{default:v(()=>[h(f(T),null,{default:v(()=>[h(f(B),{label:"订单总数",value:f(o).pagination.total},{prefix:v(()=>[h(f(U),{size:"20",color:"#18a058"},{default:v(()=>[h(f(Y))]),_:1})]),_:1},8,["value"])]),_:1}),h(f(T),null,{default:v(()=>[h(f(B),{label:"已完成",value:W("completed")},{prefix:v(()=>[h(f(U),{size:"20",color:"#2080f0"},{default:v(()=>[h(f(J))]),_:1})]),_:1},8,["value"])]),_:1}),h(f(T),null,{default:v(()=>[h(f(B),{label:"生产中",value:W("production")},{prefix:v(()=>[h(f(U),{size:"20",color:"#f0a020"},{default:v(()=>[h(f(G))]),_:1})]),_:1},8,["value"])]),_:1}),h(f(T),null,{default:v(()=>[h(f(B),{label:"总利润 (USD)",value:o.orders.reduce((e,t)=>e+(t.profit||0),0),precision:2},{prefix:v(()=>[h(f(U),{size:"20",color:"#d03050"},{default:v(()=>[h(f(N))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),h(f(F),{columns:C.value,data:f(o).orders,loading:f(o).loading,pagination:b.value,"row-key":e=>e.id,bordered:!1,striped:""},null,8,["columns","data","loading","pagination","row-key"])]),_:1})]),_:1}),h(ne,{visible:i.value,"onUpdate:visible":l[4]||(l[4]=e=>i.value=e),order:c.value,onSuccess:ie},null,8,["visible","order"])]))}}),[["__scopeId","data-v-52243fd0"]]);export{ie as default};
