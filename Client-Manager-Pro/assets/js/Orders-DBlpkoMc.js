import{k as e,a0 as t,Y as a,a3 as l,a6 as r,S as o,r as n,c as u,w as i,W as s,Z as d,N as c,_ as p,j as v,a5 as m,m as f,o as h}from"./vue-vendor-AGKXruha.js";import{s as g,T as w}from"./index-DAz_rvSd.js";import{u as k}from"./customer-yRo_pr2K.js";import{h as _,f as y,i as x,d as b}from"./helpers-Ba1kvV6f.js";import{u as S,H as C,h as O,Q as z,i as j,a3 as D,a2 as R,g as U,B as M,y as $,W as q,z as T,j as B,q as F,d as E,C as I,D as L,S as H,R as P}from"./naive-ui-DL6zjJD3.js";import{S as V}from"./SearchOutline-C3SMgW99.js";import{D as W,A as Y}from"./DocumentTextOutline-BCRJIBAN.js";import{T as A,C as N}from"./TimeOutline-B_AJ_rR8.js";import{_ as Q}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./supabase-BUHeOf8C.js";const Z={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},G=e({name:"CheckmarkCircleOutline",render:function(e,r){return a(),t("svg",Z,r[0]||(r[0]=[l("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M352 176L217.6 336L160 272"},null,-1)]))}}),J={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},K=e({name:"CreateOutline",render:function(e,r){return a(),t("svg",J,r[0]||(r[0]=[l("path",{d:"M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),l("path",{d:"M459.94 53.25a16.06 16.06 0 0 0-23.22-.56L424.35 65a8 8 0 0 0 0 11.31l11.34 11.32a8 8 0 0 0 11.34 0l12.06-12c6.1-6.09 6.67-16.01.85-22.38z",fill:"currentColor"},null,-1),l("path",{d:"M399.34 90L218.82 270.2a9 9 0 0 0-2.31 3.93L208.16 299a3.91 3.91 0 0 0 4.86 4.86l24.85-8.35a9 9 0 0 0 3.93-2.31L422 112.66a9 9 0 0 0 0-12.66l-9.95-10a9 9 0 0 0-12.71 0z",fill:"currentColor"},null,-1)]))}}),X={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ee=e({name:"EllipsisHorizontalOutline",render:function(e,r){return a(),t("svg",X,r[0]||(r[0]=[l("circle",{cx:"256",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("circle",{cx:"416",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("circle",{cx:"96",cy:"256",r:"32",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),te={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ae=e({name:"RefreshOutline",render:function(e,r){return a(),t("svg",te,r[0]||(r[0]=[l("path",{d:"M320 146s24.36-12-64-12a160 160 0 1 0 160 160",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-miterlimit":"10","stroke-width":"32"},null,-1),l("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 58l80 80l-80 80"},null,-1)]))}}),le={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},re=e({name:"TrashOutline",render:function(e,l){return a(),t("svg",le,l[0]||(l[0]=[r('<path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352" fill="currentColor"></path><path d="M192 112V72h0a23.93 23.93 0 0 1 24-24h80a23.93 23.93 0 0 1 24 24h0v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M256 176v224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M184 176l8 224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M328 176l-8 224"></path>',6)]))}}),oe=o("order",()=>{const e=n([]),t=n(null),a=n(!1),l=n({page:1,pageSize:20,total:0});return{orders:e,currentOrder:t,loading:a,pagination:l,fetchOrders:async function(t){a.value=!0;try{let a=g.from(w.ORDERS).select("*, customer:customers(id, code, company, contact)",{count:"exact"});t&&(t.keyword&&(a=a.or(`order_no.ilike.%${t.keyword}%,product.ilike.%${t.keyword}%`)),t.status&&(a=a.eq("status",t.status)),t.customer_id&&(a=a.eq("customer_id",t.customer_id)),t.date_from&&(a=a.gte("create_date",t.date_from)),t.date_to&&(a=a.lte("create_date",t.date_to)));const r=(l.value.page-1)*l.value.pageSize,o=r+l.value.pageSize-1,{data:n,error:u,count:i}=await a.order("create_date",{ascending:!1}).range(r,o);if(u)throw u;e.value=n||[],l.value.total=i||0}catch(r){throw console.error("Failed to fetch orders:",r),r}finally{a.value=!1}},fetchOrdersByCustomer:async function(e){a.value=!0;try{const{data:t,error:a}=await g.from(w.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("customer_id",e).order("create_date",{ascending:!1});if(a)throw a;return t||[]}catch(t){return console.error("Failed to fetch customer orders:",t),[]}finally{a.value=!1}},fetchOrderById:async function(e){a.value=!0;try{const{data:a,error:l}=await g.from(w.ORDERS).select("*, customer:customers(id, code, company, contact)").eq("id",e).single();if(l)throw l;return t.value=a,a}catch(l){return console.error("Failed to fetch order:",l),null}finally{a.value=!1}},createOrder:async function(t){a.value=!0;try{const{data:a,error:r}=await g.from(w.ORDERS).insert(t).select("*, customer:customers(id, code, company, contact)").single();return r||(a&&(e.value.unshift(a),l.value.total++),null)}catch(r){return console.error("Failed to create order:",r),r}finally{a.value=!1}},updateOrder:async function(l,r){a.value=!0;try{const{data:a,error:o}=await g.from(w.ORDERS).update(r).eq("id",l).select("*, customer:customers(id, code, company, contact)").single();if(o)return o;if(a){const r=e.value.findIndex(e=>e.id===l);-1!==r&&(e.value[r]=a),t.value?.id===l&&(t.value={...t.value,...a})}return null}catch(o){return console.error("Failed to update order:",o),o}finally{a.value=!1}},deleteOrder:async function(r){a.value=!0;try{const{error:a}=await g.from(w.ORDERS).delete().eq("id",r);return a||(e.value=e.value.filter(e=>e.id!==r),l.value.total--,t.value?.id===r&&(t.value=null),null)}catch(o){return console.error("Failed to delete order:",o),o}finally{a.value=!1}}}}),ne=e({__name:"OrderFormModal",props:{visible:{type:Boolean},order:{default:null}},emits:["update:visible","success"],setup(e,{emit:t}){const l=e,r=t,o=S(),f=oe(),h=k(),g=n(null),w=n(!1),y=u(()=>!!l.order),x=u({get:()=>l.visible,set:e=>r("update:visible",e)}),b=n({customer_id:"",order_no:"",product:"",profit:0,status:"pending",create_date:Date.now(),remark:""}),q=u(()=>h.customers.map(e=>({label:`${e.code} - ${e.company}`,value:e.id}))),T=[{label:_("pending"),value:"pending"},{label:_("confirmed"),value:"confirmed"},{label:_("production"),value:"production"},{label:_("shipped"),value:"shipped"},{label:_("completed"),value:"completed"},{label:_("cancelled"),value:"cancelled"}],B={customer_id:[{required:!0,message:"请选择客户",trigger:"change"}],order_no:[{required:!0,message:"请输入订单号",trigger:"blur"}],product:[{required:!0,message:"请输入产品",trigger:"blur"}],status:[{required:!0,message:"请选择订单状态",trigger:"change"}],create_date:[{required:!0,type:"number",message:"请选择创建日期",trigger:"change"}]};function F(e){const t=h.customers.find(t=>t.id===e);t&&!y.value&&(b.value.product=t.product||"")}function E(){const e=new Date;return`ORD${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${Math.floor(1e3*Math.random()).toString().padStart(3,"0")}`}async function I(){if(g.value)try{await g.value.validate(),w.value=!0;const e={customer_id:b.value.customer_id,order_no:b.value.order_no,product:b.value.product,profit:b.value.profit,status:b.value.status,create_date:new Date(b.value.create_date).toISOString().split("T")[0],remark:b.value.remark};let t;t=y.value&&l.order?await f.updateOrder(l.order.id,e):await f.createOrder(e),t?o.error(t.message||"操作失败"):(o.success(y.value?"订单已更新":"订单已创建"),r("success"),x.value=!1)}catch(e){}finally{w.value=!1}}function L(){x.value=!1}return i(()=>l.visible,e=>{var t;e&&(l.order?(t=l.order,b.value={customer_id:t.customer_id,order_no:t.order_no,product:t.product,profit:t.profit||0,status:t.status,create_date:new Date(t.create_date).getTime(),remark:t.remark||""}):b.value={customer_id:"",order_no:E(),product:"",profit:0,status:"pending",create_date:Date.now(),remark:""},0===h.customers.length&&h.fetchCustomers())}),(e,t)=>(a(),s(c(C),{show:x.value,"onUpdate:show":t[7]||(t[7]=e=>x.value=e),preset:"card",title:y.value?"编辑订单":"新增订单",style:{width:"600px"},"mask-closable":!1},{footer:d(()=>[p(c($),{justify:"end"},{default:d(()=>[p(c(M),{onClick:L},{default:d(()=>[...t[9]||(t[9]=[v("取消",-1)])]),_:1}),p(c(M),{type:"primary",loading:w.value,onClick:I},{default:d(()=>[v(m(y.value?"保存":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:d(()=>[p(c(U),{ref_key:"formRef",ref:g,model:b.value,rules:B,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:d(()=>[p(c(O),{label:"客户",path:"customer_id"},{default:d(()=>[p(c(z),{value:b.value.customer_id,"onUpdate:value":[t[0]||(t[0]=e=>b.value.customer_id=e),F],options:q.value,placeholder:"请选择客户",filterable:"",clearable:""},null,8,["value","options"])]),_:1}),p(c(O),{label:"订单号",path:"order_no"},{default:d(()=>[p(c(j),{value:b.value.order_no,"onUpdate:value":t[1]||(t[1]=e=>b.value.order_no=e),placeholder:"自动生成或手动输入"},null,8,["value"])]),_:1}),p(c(O),{label:"产品",path:"product"},{default:d(()=>[p(c(j),{value:b.value.product,"onUpdate:value":t[2]||(t[2]=e=>b.value.product=e),placeholder:"请输入产品名称",type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["value"])]),_:1}),p(c(O),{label:"利润 (USD)",path:"profit"},{default:d(()=>[p(c(D),{value:b.value.profit,"onUpdate:value":t[3]||(t[3]=e=>b.value.profit=e),placeholder:"请输入利润金额",min:0,precision:2,style:{width:"100%"}},{prefix:d(()=>[...t[8]||(t[8]=[v("$",-1)])]),_:1},8,["value"])]),_:1}),p(c(O),{label:"订单状态",path:"status"},{default:d(()=>[p(c(z),{value:b.value.status,"onUpdate:value":t[4]||(t[4]=e=>b.value.status=e),options:T,placeholder:"请选择订单状态"},null,8,["value"])]),_:1}),p(c(O),{label:"创建日期",path:"create_date"},{default:d(()=>[p(c(R),{value:b.value.create_date,"onUpdate:value":t[5]||(t[5]=e=>b.value.create_date=e),type:"date",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),p(c(O),{label:"备注",path:"remark"},{default:d(()=>[p(c(j),{value:b.value.remark,"onUpdate:value":t[6]||(t[6]=e=>b.value.remark=e),placeholder:"请输入备注信息",type:"textarea",autosize:{minRows:3,maxRows:6}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]))}}),ue={class:"orders-view"},ie=Q(e({__name:"Orders",setup(e){const l=S(),r=q(),o=oe(),i=k(),s=n(!1),m=n(null),g=n(null),w=n({keyword:"",status:null,customer_id:null,date_from:"",date_to:""}),C=u(()=>i.customers.map(e=>({label:`${e.code} - ${e.company}`,value:e.id}))),O=[{label:_("pending"),value:"pending"},{label:_("confirmed"),value:"confirmed"},{label:_("production"),value:"production"},{label:_("shipped"),value:"shipped"},{label:_("completed"),value:"completed"},{label:_("cancelled"),value:"cancelled"}],D=u(()=>({page:o.pagination.page,pageSize:o.pagination.pageSize,pageCount:Math.ceil(o.pagination.total/o.pagination.pageSize),itemCount:o.pagination.total,showSizePicker:!0,pageSizes:[10,20,50,100],onChange:e=>{o.pagination.page=e,Z()},onUpdatePageSize:e=>{o.pagination.pageSize=e,o.pagination.page=1,Z()}})),U=u(()=>[{title:"订单号",key:"order_no",width:150,ellipsis:{tooltip:!0}},{title:"客户",key:"customer",width:180,ellipsis:{tooltip:!0},render:e=>e.customer?.company||"-"},{title:"产品",key:"product",ellipsis:{tooltip:!0},render:e=>e.product||"-"},{title:"利润 (USD)",key:"profit",width:120,align:"right",render:e=>e.profit?`$${e.profit.toFixed(2)}`:"-"},{title:"状态",key:"status",width:100,render:e=>f(T,{type:x(e.status),size:"small"},{default:()=>_(e.status)})},{title:"创建日期",key:"create_date",width:120,render:e=>y(e.create_date)},{title:"操作",key:"actions",width:80,align:"center",render:e=>f(F,{trigger:"click",options:[{label:"编辑",key:"edit",icon:()=>f(B,null,{default:()=>f(K)})},{label:"删除",key:"delete",icon:()=>f(B,null,{default:()=>f(re)})}],onSelect:t=>{return n=e,void("edit"===(a=t)?(m.value=n,s.value=!0):"delete"===a&&function(e){r.warning({title:"确认删除",content:`确定要删除订单 "${e.order_no}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{const t=await o.deleteOrder(e.id);t?l.error("删除失败："+t.message):(l.success("订单已删除"),Z())}})}(n));var a,n}},{default:()=>f(M,{text:!0,size:"small"},{icon:()=>f(B,{size:20},{default:()=>f(ee)})})})}]);function Q(e){return o.orders.filter(t=>t.status===e).length}async function Z(){try{await o.fetchOrders(w.value)}catch(e){l.error("加载订单失败："+e.message)}}const J=b(()=>{o.pagination.page=1,Z()},300);function X(e){e?(w.value.date_from=new Date(e[0]).toISOString().split("T")[0],w.value.date_to=new Date(e[1]).toISOString().split("T")[0]):(w.value.date_from="",w.value.date_to=""),J()}function te(){m.value=null,s.value=!0}function le(){Z()}function ie(){Z()}return h(()=>{Z(),0===i.customers.length&&i.fetchCustomers()}),(e,l)=>(a(),t("div",ue,[p(c(E),{title:"订单管理",bordered:!1},{"header-extra":d(()=>[p(c($),null,{default:d(()=>[p(c(M),{type:"primary",onClick:te},{icon:d(()=>[p(c(B),null,{default:d(()=>[p(c(Y))]),_:1})]),default:d(()=>[l[5]||(l[5]=v(" 新增订单 ",-1))]),_:1}),p(c(M),{onClick:le},{icon:d(()=>[p(c(B),null,{default:d(()=>[p(c(ae))]),_:1})]),default:d(()=>[l[6]||(l[6]=v(" 刷新 ",-1))]),_:1})]),_:1})]),default:d(()=>[p(c($),{vertical:"",size:"large"},{default:d(()=>[p(c($),null,{default:d(()=>[p(c(j),{value:w.value.keyword,"onUpdate:value":[l[0]||(l[0]=e=>w.value.keyword=e),c(J)],placeholder:"搜索订单号、产品",style:{width:"250px"},clearable:""},{prefix:d(()=>[p(c(B),null,{default:d(()=>[p(c(V))]),_:1})]),_:1},8,["value","onUpdate:value"]),p(c(z),{value:w.value.status,"onUpdate:value":[l[1]||(l[1]=e=>w.value.status=e),c(J)],placeholder:"订单状态",style:{width:"150px"},clearable:"",options:O},null,8,["value","onUpdate:value"]),p(c(z),{value:w.value.customer_id,"onUpdate:value":[l[2]||(l[2]=e=>w.value.customer_id=e),c(J)],placeholder:"客户筛选",style:{width:"200px"},clearable:"",filterable:"",options:C.value},null,8,["value","options","onUpdate:value"]),p(c(R),{value:g.value,"onUpdate:value":[l[3]||(l[3]=e=>g.value=e),X],type:"daterange",clearable:"",placeholder:"创建日期范围"},null,8,["value"])]),_:1}),p(c(I),{cols:4,"x-gap":16},{default:d(()=>[p(c(L),null,{default:d(()=>[p(c(H),{label:"订单总数",value:c(o).pagination.total},{prefix:d(()=>[p(c(B),{size:"20",color:"#18a058"},{default:d(()=>[p(c(W))]),_:1})]),_:1},8,["value"])]),_:1}),p(c(L),null,{default:d(()=>[p(c(H),{label:"已完成",value:Q("completed")},{prefix:d(()=>[p(c(B),{size:"20",color:"#2080f0"},{default:d(()=>[p(c(G))]),_:1})]),_:1},8,["value"])]),_:1}),p(c(L),null,{default:d(()=>[p(c(H),{label:"生产中",value:Q("production")},{prefix:d(()=>[p(c(B),{size:"20",color:"#f0a020"},{default:d(()=>[p(c(A))]),_:1})]),_:1},8,["value"])]),_:1}),p(c(L),null,{default:d(()=>[p(c(H),{label:"总利润 (USD)",value:o.orders.reduce((e,t)=>e+(t.profit||0),0),precision:2},{prefix:d(()=>[p(c(B),{size:"20",color:"#d03050"},{default:d(()=>[p(c(N))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),p(c(P),{columns:U.value,data:c(o).orders,loading:c(o).loading,pagination:D.value,"row-key":e=>e.id,bordered:!1,striped:""},null,8,["columns","data","loading","pagination","row-key"])]),_:1})]),_:1}),p(ne,{visible:s.value,"onUpdate:visible":l[4]||(l[4]=e=>s.value=e),order:m.value,onSuccess:ie},null,8,["visible","order"])]))}}),[["__scopeId","data-v-52243fd0"]]);export{ie as default};
