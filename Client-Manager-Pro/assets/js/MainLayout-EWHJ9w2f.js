import{k as e,a0 as l,a3 as o,Y as t,S as a,r as n,c as r,a4 as s,m as i,o as u,W as d,Z as c,N as p,_ as m,a2 as f,j as w,a5 as h,X as v,R as k,F as g,a1 as y}from"./vue-vendor-AGKXruha.js";import{u as _,s as x,T as C}from"./index-DAz_rvSd.js";import{f as j}from"./helpers-Ba1kvV6f.js";import{_ as O}from"./CustomerFormModal.vue_vue_type_script_setup_true_lang-CV9OQ1-V.js";import{j as S,k as F,l as b,m as L,o as M,i as z,B as U,p as P,q as A,r as q,s as R,t as W,v as B,w as D,x as I,y as T,z as V,A as E}from"./naive-ui-DL6zjJD3.js";import{P as H,S as N,N as K}from"./StatsChartOutline-DPUErrvf.js";import{D as X,A as Y}from"./DocumentTextOutline-BCRJIBAN.js";import{S as Z}from"./SearchOutline-C3SMgW99.js";import{_ as G}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./supabase-BUHeOf8C.js";import"./customer-yRo_pr2K.js";const J={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Q=e({name:"HomeOutline",render:function(e,a){return t(),l("svg",J,a[0]||(a[0]=[o("path",{d:"M80 212v236a16 16 0 0 0 16 16h96V328a24 24 0 0 1 24-24h80a24 24 0 0 1 24 24v136h96a16 16 0 0 0 16-16V212",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),o("path",{d:"M480 256L266.89 52c-5-5.28-16.69-5.34-21.78 0L32 256",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),o("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M400 179V64h-48v69"},null,-1)]))}}),$={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ee=e({name:"LogOutOutline",render:function(e,a){return t(),l("svg",$,a[0]||(a[0]=[o("path",{d:"M304 336v40a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V136a40 40 0 0 1 40-40h152c22.09 0 48 17.91 48 40v40",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),o("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M368 336l80-80l-80-80"},null,-1),o("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M176 256h256"},null,-1)]))}}),le={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},oe=e({name:"PersonCircleOutline",render:function(e,a){return t(),l("svg",le,a[0]||(a[0]=[o("path",{d:"M258.9 48C141.92 46.42 46.42 141.92 48 258.9c1.56 112.19 92.91 203.54 205.1 205.1c117 1.6 212.48-93.9 210.88-210.88C462.44 140.91 371.09 49.56 258.9 48zm126.42 327.25a4 4 0 0 1-6.14-.32a124.27 124.27 0 0 0-32.35-29.59C321.37 329 289.11 320 256 320s-65.37 9-90.83 25.34a124.24 124.24 0 0 0-32.35 29.58a4 4 0 0 1-6.14.32A175.32 175.32 0 0 1 80 259c-1.63-97.31 78.22-178.76 175.57-179S432 158.81 432 256a175.32 175.32 0 0 1-46.68 119.25z",fill:"currentColor"},null,-1),o("path",{d:"M256 144c-19.72 0-37.55 7.39-50.22 20.82s-19 32-17.57 51.93C191.11 256 221.52 288 256 288s64.83-32 67.79-71.24c1.48-19.74-4.8-38.14-17.68-51.82C293.39 151.44 275.59 144 256 144z",fill:"currentColor"},null,-1)]))}}),te={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ae=e({name:"SettingsOutline",render:function(e,a){return t(),l("svg",te,a[0]||(a[0]=[o("path",{d:"M262.29 192.31a64 64 0 1 0 57.4 57.4a64.13 64.13 0 0 0-57.4-57.4zM416.39 256a154.34 154.34 0 0 1-1.53 20.79l45.21 35.46a10.81 10.81 0 0 1 2.45 13.75l-42.77 74a10.81 10.81 0 0 1-13.14 4.59l-44.9-18.08a16.11 16.11 0 0 0-15.17 1.75A164.48 164.48 0 0 1 325 400.8a15.94 15.94 0 0 0-8.82 12.14l-6.73 47.89a11.08 11.08 0 0 1-10.68 9.17h-85.54a11.11 11.11 0 0 1-10.69-8.87l-6.72-47.82a16.07 16.07 0 0 0-9-12.22a155.3 155.3 0 0 1-21.46-12.57a16 16 0 0 0-15.11-1.71l-44.89 18.07a10.81 10.81 0 0 1-13.14-4.58l-42.77-74a10.8 10.8 0 0 1 2.45-13.75l38.21-30a16.05 16.05 0 0 0 6-14.08c-.36-4.17-.58-8.33-.58-12.5s.21-8.27.58-12.35a16 16 0 0 0-6.07-13.94l-38.19-30A10.81 10.81 0 0 1 49.48 186l42.77-74a10.81 10.81 0 0 1 13.14-4.59l44.9 18.08a16.11 16.11 0 0 0 15.17-1.75A164.48 164.48 0 0 1 187 111.2a15.94 15.94 0 0 0 8.82-12.14l6.73-47.89A11.08 11.08 0 0 1 213.23 42h85.54a11.11 11.11 0 0 1 10.69 8.87l6.72 47.82a16.07 16.07 0 0 0 9 12.22a155.3 155.3 0 0 1 21.46 12.57a16 16 0 0 0 15.11 1.71l44.89-18.07a10.81 10.81 0 0 1 13.14 4.58l42.77 74a10.8 10.8 0 0 1-2.45 13.75l-38.21 30a16.05 16.05 0 0 0-6.05 14.08c.33 4.14.55 8.3.55 12.47z",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1)]))}}),ne=a("followup",()=>{const e=n([]),l=n(!1),o=_();return{followups:e,loading:l,fetchFollowups:async function(o){l.value=!0;try{let l=x.from(C.FOLLOWUPS).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)");o&&(l=l.eq("customer_id",o));const{data:t,error:a}=await l.order("follow_date",{ascending:!1});if(a)throw a;e.value=t||[]}catch(t){throw console.error("Failed to fetch followups:",t),t}finally{l.value=!1}},createFollowup:async function(t){l.value=!0;try{const l={...t,follower_id:t.follower_id||o.user?.id},{data:a,error:n}=await x.from(C.FOLLOWUPS).insert(l).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").single();if(n)throw n;return e.value.unshift(a),t.customer_id&&await x.from(C.CUSTOMERS).update({last_follow_date:t.follow_date}).eq("id",t.customer_id),a}catch(a){throw console.error("Failed to create followup:",a),a}finally{l.value=!1}},updateFollowup:async function(o,t){l.value=!0;try{const{data:l,error:a}=await x.from(C.FOLLOWUPS).update(t).eq("id",o).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").single();if(a)throw a;const n=e.value.findIndex(e=>e.id===o);return-1!==n&&(e.value[n]=l),!0}catch(a){throw console.error("Failed to update followup:",a),a}finally{l.value=!1}},deleteFollowup:async function(o){l.value=!0;try{const{error:l}=await x.from(C.FOLLOWUPS).delete().eq("id",o);if(l)throw l;return e.value=e.value.filter(e=>e.id!==o),!0}catch(t){throw console.error("Failed to delete followup:",t),t}finally{l.value=!1}},fetchPendingReminders:async function(){try{const e=(new Date).toISOString().split("T")[0],{data:l,error:o}=await x.from(C.FOLLOWUPS).select("*, follower:users!follower_id(id, email, name), customer:customers(id, code, company)").lte("remind_at",e).not("remind_at","is",null).order("remind_at",{ascending:!0});if(o)throw o;return l||[]}catch(e){return console.error("Failed to fetch pending reminders:",e),[]}}}}),re={class:"logo"},se={key:0},ie={key:1},ue={style:{display:"flex","align-items":"center",gap:"16px"}},de={style:{display:"flex","align-items":"center",gap:"16px"}},ce=G(e({__name:"MainLayout",setup(e){const a=y(),x=s(),C=_(),G=ne(),J=n(!1),$=n(""),le=n(!1),te=n(!1),ce=n([]),pe=r(()=>x.name),me=r(()=>{const e=[{label:"仪表盘",key:"Dashboard",icon:()=>i(S,null,{default:()=>i(Q)})},{label:"客户管理",key:"Customers",icon:()=>i(S,null,{default:()=>i(H)})},{label:"订单管理",key:"Orders",icon:()=>i(S,null,{default:()=>i(X)})},{label:"统计报表",key:"Reports",icon:()=>i(S,null,{default:()=>i(N)})}];return C.isAdmin&&e.push({label:"系统设置",key:"Settings",icon:()=>i(S,null,{default:()=>i(ae)})}),e}),fe=[{label:"退出登录",key:"logout",icon:()=>i(S,null,{default:()=>i(ee)})}];function we(e){a.push({name:e})}function he(){$.value&&a.push({name:"Customers",query:{keyword:$.value}})}function ve(e){"logout"===e&&(C.signOut(),a.push({name:"Login"}))}function ke(){le.value=!1,"Customers"===x.name&&a.go(0)}async function ge(){ce.value=await G.fetchPendingReminders()}return u(()=>{ge(),setInterval(ge,3e5)}),(e,a)=>{const n=v("router-view");return t(),d(p(F),{"has-sider":"",style:{height:"100vh"}},{default:c(()=>[m(p(L),{bordered:"","collapse-mode":"width","collapsed-width":64,width:240,collapsed:J.value,"show-trigger":"",onCollapse:a[0]||(a[0]=e=>J.value=!0),onExpand:a[1]||(a[1]=e=>J.value=!1)},{default:c(()=>[o("div",re,[J.value?(t(),l("h2",ie,"CRM")):(t(),l("h2",se,"客户管理系统"))]),m(p(b),{collapsed:J.value,"collapsed-width":64,"collapsed-icon-size":22,options:me.value,value:pe.value,"onUpdate:value":we},null,8,["collapsed","options","value"])]),_:1},8,["collapsed"]),m(p(F),null,{default:c(()=>[m(p(M),{bordered:"",style:{height:"64px",padding:"0 24px",display:"flex","align-items":"center","justify-content":"space-between"}},{default:c(()=>[o("div",ue,[m(p(z),{value:$.value,"onUpdate:value":a[2]||(a[2]=e=>$.value=e),placeholder:"搜索客户...",clearable:"",style:{width:"300px"},onKeyup:f(he,["enter"])},{prefix:c(()=>[m(p(S),{component:p(Z)},null,8,["component"])]),_:1},8,["value"]),m(p(U),{type:"primary",onClick:a[3]||(a[3]=e=>le.value=!0)},{icon:c(()=>[m(p(S),{component:p(Y)},null,8,["component"])]),default:c(()=>[a[7]||(a[7]=w(" 新增客户 ",-1))]),_:1})]),o("div",de,[m(p(P),{value:ce.value.length,max:99},{default:c(()=>[m(p(U),{circle:"",quaternary:"",onClick:a[4]||(a[4]=e=>te.value=!0)},{icon:c(()=>[m(p(S),{component:p(K)},null,8,["component"])]),_:1})]),_:1},8,["value"]),m(p(A),{options:fe,onSelect:ve},{default:c(()=>[m(p(U),{text:"",style:{"font-size":"14px"}},{icon:c(()=>[m(p(S),{component:p(oe)},null,8,["component"])]),default:c(()=>[w(" "+h(p(C).user?.name||p(C).user?.email),1)]),_:1})]),_:1})])]),_:1}),m(p(q),{"content-style":"padding: 24px;","native-scrollbar":!1},{default:c(()=>[m(n)]),_:1})]),_:1}),m(O,{show:le.value,"onUpdate:show":a[5]||(a[5]=e=>le.value=e),onSuccess:ke},null,8,["show"]),m(p(E),{show:te.value,"onUpdate:show":a[6]||(a[6]=e=>te.value=e),width:400,placement:"right"},{default:c(()=>[m(p(R),{title:"待办提醒",closable:""},{default:c(()=>[0===ce.value.length?(t(),d(p(W),{key:0,description:"暂无待办提醒"})):(t(),d(p(B),{key:1},{default:c(()=>[(t(!0),l(g,null,k(ce.value,e=>(t(),d(p(D),{key:e.id},{default:c(()=>[m(p(I),{title:e.customer?.company||"未知客户"},{description:c(()=>[m(p(T),{vertical:"",size:"small"},{default:c(()=>[o("span",null,h(e.content),1),m(p(V),{size:"small",type:"warning"},{default:c(()=>[w(" 提醒时间: "+h(p(j)(e.remind_at)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1},8,["show"])]),_:1})}}}),[["__scopeId","data-v-ee2b0f31"]]);export{ce as default};
