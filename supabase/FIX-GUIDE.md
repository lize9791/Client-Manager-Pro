# ğŸ”§ "Cannot coerce to single JSON object" é”™è¯¯ä¿®å¤æŒ‡å—

## é—®é¢˜åŸå› 

è¿™ä¸ªé”™è¯¯å‘ç”Ÿæ˜¯å› ä¸ºï¼š
1. ç”¨æˆ·åœ¨ `auth.users` ä¸­æ³¨å†ŒæˆåŠŸ
2. ä½† `public.users` è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„è®°å½•
3. å‰ç«¯æŸ¥è¯¢æ—¶ä½¿ç”¨ `.single()` æœŸæœ›è¿”å›ä¸€æ¡è®°å½•ï¼Œä½†å®é™…è¿”å› 0 æ¡

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆï¼ˆ3 æ­¥ï¼‰

### ç¬¬ 1 æ­¥ï¼šä¿®å¤ç°æœ‰ç”¨æˆ·æ•°æ®

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- å¤åˆ¶å¹¶æ‰§è¡Œ fix-user-sync.sql çš„å†…å®¹
```

è¿™ä¼šä¸ºæ‰€æœ‰å·²å­˜åœ¨çš„ auth ç”¨æˆ·åˆ›å»ºå¯¹åº”çš„ public.users è®°å½•ã€‚

---

### ç¬¬ 2 æ­¥ï¼šè®¾ç½®è‡ªåŠ¨è§¦å‘å™¨

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- å¤åˆ¶å¹¶æ‰§è¡Œ setup-user-trigger.sql çš„å†…å®¹
```

è¿™ä¼šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œä»¥åæ–°æ³¨å†Œçš„ç”¨æˆ·ä¼šè‡ªåŠ¨åœ¨ public.users ä¸­åˆ›å»ºè®°å½•ã€‚

---

### ç¬¬ 3 æ­¥ï¼šåˆ·æ–°å‰ç«¯åº”ç”¨

1. **é‡å¯å¼€å‘æœåŠ¡å™¨**ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰ï¼š
   ```bash
   # æŒ‰ Ctrl+C åœæ­¢ï¼Œç„¶åé‡æ–°å¯åŠ¨
   npm run dev
   ```

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢**
   - æŒ‰ `Ctrl + Shift + R`ï¼ˆWindows/Linuxï¼‰
   - æˆ– `Cmd + Shift + R`ï¼ˆMacï¼‰

3. **é‡æ–°ç™»å½•**

---

## ğŸ” éªŒè¯ä¿®å¤

æ‰§è¡Œä»¥ä¸‹ SQL æ£€æŸ¥ï¼š

```sql
-- 1. æ£€æŸ¥æ‰€æœ‰ auth ç”¨æˆ·æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„ public.users è®°å½•
SELECT
  au.email,
  CASE WHEN u.id IS NULL THEN 'âŒ ç¼ºå¤±' ELSE 'âœ… æ­£å¸¸' END as status,
  u.role
FROM auth.users au
LEFT JOIN public.users u ON u.id = au.id;
```

æ‰€æœ‰ç”¨æˆ·çš„ status åº”è¯¥éƒ½æ˜¯ "âœ… æ­£å¸¸"ã€‚

```sql
-- 2. æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦å·²åˆ›å»º
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'on_auth_user_created';
```

åº”è¯¥çœ‹åˆ°è§¦å‘å™¨å·²åˆ›å»ºã€‚

---

## ğŸ§ª æµ‹è¯•

1. **æµ‹è¯•ç°æœ‰ç”¨æˆ·ç™»å½•**ï¼š
   - ä½¿ç”¨ç°æœ‰è´¦å·ç™»å½•
   - åº”è¯¥èƒ½æ­£å¸¸è¿›å…¥ä»ªè¡¨ç›˜

2. **æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œ**ï¼ˆå¯é€‰ï¼‰ï¼š
   - æ³¨å†Œä¸€ä¸ªæ–°è´¦å·
   - æ£€æŸ¥ public.users è¡¨ï¼Œåº”è¯¥è‡ªåŠ¨åˆ›å»ºäº†è®°å½•
   - æ–°ç”¨æˆ·åº”è¯¥èƒ½æ­£å¸¸ç™»å½•

---

## ğŸ“Š å¦‚æœè¿˜æœ‰é—®é¢˜

### é”™è¯¯ä»ç„¶å‡ºç°ï¼Ÿ

1. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**ï¼š
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹ Console æ ‡ç­¾ä¸­çš„é”™è¯¯ä¿¡æ¯
   - æˆªå›¾å‘ç»™æˆ‘

2. **æ£€æŸ¥æ•°æ®åº“**ï¼š
   ```sql
   -- æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯
   SELECT auth.uid() as my_id;

   -- æŸ¥çœ‹è¯¥ç”¨æˆ·åœ¨ public.users ä¸­æ˜¯å¦å­˜åœ¨
   SELECT * FROM public.users WHERE id = auth.uid();
   ```

3. **å¼ºåˆ¶é‡æ–°åˆ›å»ºç”¨æˆ·è®°å½•**ï¼š
   ```sql
   -- æ›¿æ¢ 'your-email@example.com' ä¸ºä½ çš„é‚®ç®±
   DELETE FROM public.users WHERE email = 'your-email@example.com';

   -- é‡æ–°åˆ›å»º
   INSERT INTO public.users (id, email, name, role)
   SELECT id, email, SPLIT_PART(email, '@', 1), 'admin'
   FROM auth.users
   WHERE email = 'your-email@example.com';
   ```

---

## ğŸ¯ å‰ç«¯ä»£ç å·²è‡ªåŠ¨ä¿®å¤

å‰ç«¯ä»£ç å·²ç»æ›´æ–°ï¼Œç°åœ¨ä¼šï¼š
1. ä½¿ç”¨ `.maybeSingle()` ä»£æ›¿ `.single()`
2. å¦‚æœæŸ¥è¯¢ä¸åˆ°ç”¨æˆ·è®°å½•ï¼Œè‡ªåŠ¨åˆ›å»º
3. æ›´å¥½åœ°å¤„ç†é”™è¯¯æƒ…å†µ

æ–‡ä»¶ä½ç½®ï¼š`src/stores/auth.ts` (å·²è‡ªåŠ¨ä¿®å¤)

---

## ğŸ“ æ€»ç»“

æ‰§è¡Œé¡ºåºï¼š
1. âœ… æ‰§è¡Œ `fix-user-sync.sql` - ä¿®å¤ç°æœ‰æ•°æ®
2. âœ… æ‰§è¡Œ `setup-user-trigger.sql` - è®¾ç½®è‡ªåŠ¨è§¦å‘å™¨
3. âœ… é‡å¯å¼€å‘æœåŠ¡å™¨
4. âœ… æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢
5. âœ… é‡æ–°ç™»å½•

å®Œæˆååº”è¯¥å°±èƒ½æ­£å¸¸ä½¿ç”¨äº†ï¼ğŸš€
